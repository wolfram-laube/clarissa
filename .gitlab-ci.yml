# =============================================================================
# BLAUWEISS LLC - CI/CD Orchestrator
# =============================================================================
# This file is the central orchestrator for all CI/CD pipelines.
# Individual domains are separated into .gitlab/*.yml files.
#
# Architecture (ADR-XXX):
#   - Research projects (CLARISSA, future: MAGNUS, AURORA)
#   - Business operations (Billing, Applications)
#   - Platform services (Pages, CI Automation)
#   - Infrastructure (GCP, Terraform, Docker)
# =============================================================================

# -----------------------------------------------------------------------------
# INCLUDES: Domain-specific CI configurations
# -----------------------------------------------------------------------------
include:
  # === RESEARCH PROJECTS ===
  - local: '.gitlab/clarissa.yml'           # CLARISSA: Reservoir AI (Tests, OPM, Integration)
  # - local: '.gitlab/magnus.yml'           # MAGNUS: Future project
  # - local: '.gitlab/aurora.yml'           # AURORA: Future project

  # === BUSINESS OPERATIONS ===
  # - local: '.gitlab/billing.yml'           # MOVED TO backoffice            # Invoicing, Timesheets, Email
  # - local: '.gitlab/applications.yml'     # MOVED TO backoffice       # Job Applications Pipeline (existing)

  # === PLATFORM SERVICES ===
  # - local: '.gitlab/pages.yml'             # MOVED TO backoffice              # MkDocs, Portal, Publications
  # - local: '.gitlab/ci-automation.yml'    # MOVED TO backoffice      # Issue Bots, MR Reports, Flaky Ledger

  # === INFRASTRUCTURE (existing) ===
  - local: '.gitlab/infra-setup.yml'
  - local: '.gitlab/gcp-check.yml'
  - local: '.gitlab/gcp-setup.yml'
  - local: '.gitlab/gcp-vm-control.yml'
  - local: '.gitlab/terraform.yml'
  - local: '.gitlab/docker-build.yml'
  - local: '.gitlab/k3s-setup.yml'

  # === INTEGRATIONS (existing) ===
  - local: '.gitlab/gmail-drafts.yml'
  - local: '.gitlab/gdrive-upload.yml'
  - local: '.gitlab/benchmark.yml'
  - local: '.gitlab/fix-shell-runner.yml'
  - local: '.gitlab/parallel-jobs.yml'

  # === CONFERENCE PAPERS ===
  - local: 'conference/spe-europe-2026/ci/document-merge.gitlab-ci.yml'
    rules:
      - changes:
          - conference/spe-europe-2026/**/*

# -----------------------------------------------------------------------------
# WORKFLOW: Pipeline trigger rules
# -----------------------------------------------------------------------------
workflow:
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      when: always
    - if: '$CI_COMMIT_BRANCH == "main" && $CI_PIPELINE_SOURCE == "push"'
      when: always
    - if: '$CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+$/'
      when: always
    - if: '$CI_PIPELINE_SOURCE == "web"'
      when: always
    - if: '$CI_PIPELINE_SOURCE == "api"'
      when: always
    - if: '$CI_PIPELINE_SOURCE == "trigger"'
      when: always
    - if: '$CI_PIPELINE_SOURCE == "schedule"'
      when: always
    - when: never

# -----------------------------------------------------------------------------
# STAGES: Execution order
# -----------------------------------------------------------------------------
stages:
  - build
  - test
  - classify
  - automation
  - deploy

# -----------------------------------------------------------------------------
# SHARED ANCHORS: Reusable configuration blocks
# -----------------------------------------------------------------------------

# Python base configuration
.python_base: &python_base
  image: python:3.11
  tags:
    - docker-any
  variables:
    PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"
  cache:
    key: pip-cache
    paths:
      - .cache/pip

# Install development dependencies
.install_dev_deps: &install_dev_deps
  before_script:
    - python -V
    - python -m pip install --upgrade pip
    - pip uninstall clarissa -y 2>/dev/null || true
    - find $(python -c "import site; print(site.getsitepackages()[0])") -name "__editable__*" -delete 2>/dev/null || true
    - find $(python -c "import site; print(site.getsitepackages()[0])") -name "*.pth" -exec grep -l clarissa {} \; -delete 2>/dev/null || true
    - pip cache purge 2>/dev/null || true
    - python -m pip install -e ".[dev]"

# Pytest run configuration
.pytest_run: &pytest_run
  script:
    - python -m pytest -q --junitxml=junit.xml
  artifacts:
    when: always
    reports:
      junit: junit.xml
    paths:
      - junit.xml
      - .pytest_cache/

# Rule templates
.rerun_rules: &rerun_rules
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      when: on_failure
    - if: '$CI_COMMIT_BRANCH == "main" && $CI_PIPELINE_SOURCE == "push"'
      when: on_failure
    - when: never

.issue_bot_rules: &issue_bot_rules
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
      when: always
    - when: never

.recovery_bot_rules: &recovery_bot_rules
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
      when: always
    - when: never

.mr_bot_rules: &mr_bot_rules
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      when: on_success
    - when: never

.main_branch_rules: &main_branch_rules
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
      when: always
    - when: never
