gcp:fix-shell-runner:
  stage: .pre
  tags: [mac-group-shell]
  script:
    - echo "Fixing GCP Shell Runner..."
    - |
      gcloud compute ssh gitlab-runner --zone=europe-west3-a << 'REMOTE_SCRIPT'
        sudo mkdir -p /builds /cache
        sudo chmod 777 /builds /cache
        echo "=== Current config ==="
        sudo cat /etc/gitlab-runner/config.toml
        echo "=== Restarting runner ==="
        sudo systemctl restart gitlab-runner
        sleep 2
        sudo gitlab-runner status
      REMOTE_SCRIPT
  rules:
    - when: manual

gcp:install-docker-runner:
  stage: .pre
  tags: [mac-group-shell]
  script:
    - echo "Checking Docker Runner on GCP VM..."
    - |
      gcloud compute ssh gitlab-runner@gitlab-runner --zone=europe-west3-a << 'REMOTE_SCRIPT'
        set -e
        echo "=== Checking Docker ==="
        docker --version || { echo "Docker not installed!"; exit 1; }
        echo "=== Current runners ==="
        sudo gitlab-runner list
        echo "=== Docker service status ==="
        sudo systemctl status docker --no-pager || true
        echo "=== Current config ==="
        sudo cat /etc/gitlab-runner/config.toml
      REMOTE_SCRIPT
  rules:
    - when: manual
