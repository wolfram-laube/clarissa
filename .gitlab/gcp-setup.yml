gcp:install-docker-runner:
  stage: .pre
  tags: [mac-group-shell]
  script:
    - echo "Installing Docker Runner on GCP VM..."
    - |
      gcloud compute ssh gitlab-runner@gitlab-runner --zone=europe-west3-a << 'REMOTE_SCRIPT'
        set -e
        
        echo "=== Checking Docker ==="
        docker --version || { echo "Docker not installed!"; exit 1; }
        
        echo "=== Getting registration token ==="
        # We need to register a new runner
        
        echo "=== Current runners ==="
        sudo gitlab-runner list
        
        echo "=== Checking if Docker runner already exists ==="
        if sudo gitlab-runner list 2>&1 | grep -q "Docker"; then
          echo "Docker runner already configured"
        else
          echo "Docker runner not found, needs registration"
          echo "Please run manually on GCP VM:"
          echo "sudo gitlab-runner register --url https://gitlab.com --token <TOKEN> --executor docker --docker-image python:3.11-slim --description 'GCP Docker Runner'"
        fi
        
        echo "=== Docker status ==="
        sudo systemctl status docker --no-pager || true
      REMOTE_SCRIPT
  rules:
    - when: manual
