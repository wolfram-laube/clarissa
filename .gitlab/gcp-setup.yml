gcp:fix-shell-runner:
  stage: .pre
  tags: [mac-group-shell]
  script:
    - echo "Fixing GCP Shell Runner..."
    - |
      gcloud compute ssh gitlab-runner --zone=europe-west3-a --command="
        sudo mkdir -p /builds /cache
        sudo chmod 777 /builds /cache
        
        # Check if builds_dir already set
        if ! grep -q 'builds_dir' /etc/gitlab-runner/config.toml; then
          # Insert builds_dir after executor = shell line
          sudo sed -i '/executor = .shell./a\  builds_dir = "/builds"' /etc/gitlab-runner/config.toml
        fi
        
        cat /etc/gitlab-runner/config.toml
        sudo systemctl restart gitlab-runner
        sudo gitlab-runner status
      "
  rules:
    - when: manual
