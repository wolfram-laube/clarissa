# Google Drive Upload Pipeline for Benchmark Reports
#
# Uploads benchmark reports to Google Drive
# Uses Service Account: claude-assistant@myk8sproject-207017.iam.gserviceaccount.com

.gdrive_base:
  image: python:3.11-slim
  tags:
    - gcp-docker
  before_script:
    - pip install google-auth google-api-python-client --quiet

# Upload benchmark report to Google Drive
gdrive:upload-benchmark:
  extends: .gdrive_base
  stage: deploy
  rules:
    - if: $UPLOAD_BENCHMARK == "true"
      when: always
    - when: manual
      allow_failure: true
  needs: []
  variables:
    BENCHMARK_FOLDER_NAME: "Benchmarks"
  script:
    - |
      python3 << 'PYEOF'
      import json, os, sys
      from datetime import datetime
      from google.oauth2 import service_account
      from googleapiclient.discovery import build
      from googleapiclient.http import MediaFileUpload
      from googleapiclient.errors import HttpError

      # Config
      SA_KEY_PATH = os.environ.get("GOOGLE_SERVICE_ACCOUNT_KEY", "")
      ROOT_FOLDER_ID = os.environ.get("GOOGLE_DRIVE_FOLDER_ID", "1qh0skTeyRNs4g9KwAhpd3J8Yj_XENIFs")
      BENCHMARK_FOLDER = os.environ.get("BENCHMARK_FOLDER_NAME", "Benchmarks")
      PIPELINE_ID = os.environ.get("CI_PIPELINE_ID", "unknown")

      print(f"Root Folder ID: {ROOT_FOLDER_ID}")
      print(f"Subfolder: {BENCHMARK_FOLDER}")

      # Load service account
      with open(SA_KEY_PATH, 'r') as f:
          sa_key = json.load(f)
      print(f"Service Account: {sa_key.get('client_email')}")

      credentials = service_account.Credentials.from_service_account_info(
          sa_key, scopes=["https://www.googleapis.com/auth/drive.file"]
      )
      service = build("drive", "v3", credentials=credentials)

      def find_or_create_folder(parent_id, folder_name):
          """Find existing folder or create new one."""
          try:
              query = f"name='{folder_name}' and '{parent_id}' in parents and mimeType='application/vnd.google-apps.folder' and trashed=false"
              results = service.files().list(q=query, spaces='drive', fields='files(id, name)').execute()
              folders = results.get('files', [])
              if folders:
                  print(f"Found existing folder: {folder_name}")
                  return folders[0]['id']
          except HttpError as e:
              print(f"Search failed ({e.resp.status}), will create new folder")

          # Create folder
          folder_metadata = {
              'name': folder_name,
              'mimeType': 'application/vnd.google-apps.folder',
              'parents': [parent_id]
          }
          try:
              folder = service.files().create(body=folder_metadata, fields='id').execute()
              print(f"Created folder: {folder_name}")
              return folder.get('id')
          except HttpError as e:
              print(f"Failed to create folder: {e}")
              return None

      # Create Benchmarks subfolder
      benchmark_folder_id = find_or_create_folder(ROOT_FOLDER_ID, BENCHMARK_FOLDER)
      if not benchmark_folder_id:
          print("Could not access or create Benchmarks folder")
          print("Using root folder instead")
          benchmark_folder_id = ROOT_FOLDER_ID

      # Create timestamped subfolder
      timestamp = datetime.now().strftime('%Y-%m-%d_%H%M%S')
      run_folder_name = f"benchmark_{timestamp}_pipeline_{PIPELINE_ID}"
      run_folder_id = find_or_create_folder(benchmark_folder_id, run_folder_name)
      
      if not run_folder_id:
          print("Could not create run folder, uploading to Benchmarks folder")
          run_folder_id = benchmark_folder_id

      # Find benchmark files
      benchmark_dir = "docs/ci/benchmarks"
      if not os.path.exists(benchmark_dir):
          print(f"Directory {benchmark_dir} not found")
          benchmark_dir = "."

      uploaded = 0
      for filename in os.listdir(benchmark_dir):
          filepath = os.path.join(benchmark_dir, filename)
          if not os.path.isfile(filepath):
              continue

          # Determine mime type
          mimetypes = {'.md': 'text/markdown', '.json': 'application/json', 
                       '.png': 'image/png', '.ics': 'text/calendar'}
          ext = os.path.splitext(filename)[1]
          mimetype = mimetypes.get(ext, 'application/octet-stream')

          file_metadata = {'name': filename, 'parents': [run_folder_id]}
          media = MediaFileUpload(filepath, mimetype=mimetype, resumable=True)

          try:
              file = service.files().create(body=file_metadata, media_body=media, fields='id').execute()
              print(f"  Uploaded: {filename}")
              uploaded += 1
          except HttpError as e:
              print(f"  Failed: {filename} - {e.resp.status}")

      print(f"\nUploaded {uploaded} files")
      print(f"Folder: https://drive.google.com/drive/folders/{run_folder_id}")

      # Save summary
      summary = {"pipeline_id": PIPELINE_ID, "timestamp": timestamp, 
                 "folder_id": run_folder_id, "files_uploaded": uploaded}
      with open("gdrive_upload_summary.json", "w") as f:
          json.dump(summary, f, indent=2)
      PYEOF
  artifacts:
    paths:
      - gdrive_upload_summary.json
    expire_in: 1 week

# List Google Drive contents
gdrive:list:
  extends: .gdrive_base
  stage: .pre
  rules:
    - when: manual
      allow_failure: true
  script:
    - |
      python3 << 'PYEOF'
      import json, os
      from google.oauth2 import service_account
      from googleapiclient.discovery import build

      SA_KEY_PATH = os.environ.get("GOOGLE_SERVICE_ACCOUNT_KEY", "")
      FOLDER_ID = os.environ.get("GOOGLE_DRIVE_FOLDER_ID", "1qh0skTeyRNs4g9KwAhpd3J8Yj_XENIFs")

      with open(SA_KEY_PATH, 'r') as f:
          sa_key = json.load(f)

      print(f"Service Account: {sa_key.get('client_email')}")

      credentials = service_account.Credentials.from_service_account_info(
          sa_key, scopes=["https://www.googleapis.com/auth/drive.readonly"]
      )
      service = build("drive", "v3", credentials=credentials)

      # List files
      try:
          query = f"'{FOLDER_ID}' in parents and trashed=false"
          results = service.files().list(
              q=query, spaces='drive',
              fields='files(id, name, mimeType, modifiedTime, size)',
              orderBy='modifiedTime desc', pageSize=50
          ).execute()
          files = results.get('files', [])
          print(f"\nFound {len(files)} items:\n")
          for f in files:
              icon = 'D' if f['mimeType'] == 'application/vnd.google-apps.folder' else 'F'
              print(f"  [{icon}] {f['name']}")
      except Exception as e:
          print(f"Error: {e}")

      with open("gdrive_listing.json", "w") as out:
          json.dump(files if 'files' in dir() else [], out, indent=2)
      PYEOF
  artifacts:
    paths:
      - gdrive_listing.json
    expire_in: 1 day
