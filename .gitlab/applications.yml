# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
#  APPLICATIONS PIPELINE - Automated Job Hunting
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
#
#  T√§glich um 08:00 Uhr:
#  1. Crawlt freelancermap.de nach neuen Projekten
#  2. Matcht gegen Profile (Wolfram, Ian, Michael, Teams)
#  3. Erstellt Gmail-Drafts mit Attachments
#
#  Setup:
#  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
#  1. Schedule in GitLab: CI/CD ‚Üí Schedules ‚Üí "0 8 * * 1-5"
#  2. Variable: GMAIL_REFRESH_TOKEN (masked)
#
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
#  STAGE 1: CRAWL
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

applications:crawl:
  stage: .pre
  tags:
    - mac-group-shell
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule" && $APPLICATIONS_PIPELINE == "true"
    - if: $APPLICATIONS_CRAWL == "true"
    - when: manual
      allow_failure: true
  variables:
    KEYWORDS: "DevOps Kubernetes,Python Cloud,AI ML LLM,Java Spring Architekt,MLOps Platform"
    MIN_REMOTE: "50"
    MAX_PAGES: "3"
  script:
    - pip3 install requests beautifulsoup4 lxml --quiet --break-system-packages 2>/dev/null || pip3 install requests beautifulsoup4 lxml --quiet
    - |
      python3 << 'EOFPY'
      import os
      import sys
      sys.path.insert(0, os.getcwd())
      
      from src.admin.applications.pipeline.crawler import FreelancerMapCrawler
      import json
      
      keywords = os.environ.get("KEYWORDS", "DevOps,Python,AI").split(",")
      min_remote = int(os.environ.get("MIN_REMOTE", "50"))
      max_pages = int(os.environ.get("MAX_PAGES", "2"))
      
      crawler = FreelancerMapCrawler()
      all_projects = []
      
      for kw in keywords:
          print(f"üîç Searching: {kw.strip()}")
          projects = crawler.crawl(kw.strip(), max_pages=max_pages, min_remote=min_remote)
          all_projects.extend(projects)
          print(f"   ‚Üí {len(projects)} found")
      
      # Deduplicate
      seen = set()
      unique = []
      for p in all_projects:
          if p['url'] not in seen:
              seen.add(p['url'])
              unique.append(p)
      
      os.makedirs("output", exist_ok=True)
      with open("output/projects.json", "w") as f:
          json.dump(unique, f, indent=2, ensure_ascii=False)
      
      print(f"\n‚úÖ {len(unique)} unique projects saved to output/projects.json")
      EOFPY
  artifacts:
    paths:
      - output/projects.json
    expire_in: 7 days

# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
#  STAGE 2: MATCH
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

applications:match:
  stage: build
  tags:
    - mac-group-shell
  needs:
    - job: applications:crawl
      artifacts: true
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule" && $APPLICATIONS_PIPELINE == "true"
    - if: $APPLICATIONS_MATCH == "true"
    - when: manual
      allow_failure: true
  variables:
    MIN_SCORE: "50"
    MAX_RESULTS: "20"
  script:
    - |
      python3 << 'EOFPY'
      import os
      import sys
      import json
      sys.path.insert(0, os.getcwd())
      
      from src.admin.applications.pipeline.matcher import ProjectMatcher
      from src.admin.applications.pipeline.profiles import PROFILES
      
      min_score = int(os.environ.get("MIN_SCORE", "50"))
      max_results = int(os.environ.get("MAX_RESULTS", "20"))
      
      # Load projects
      with open("output/projects.json") as f:
          projects = json.load(f)
      
      print(f"üìä Matching {len(projects)} projects against {len(PROFILES)} profiles...")
      
      matcher = ProjectMatcher(PROFILES)
      results = []
      
      for project in projects:
          match = matcher.match(project)
          if match and match['score'] >= min_score:
              results.append(match)
      
      # Sort by score
      results.sort(key=lambda x: x['score'], reverse=True)
      results = results[:max_results]
      
      # Summary
      hot = sum(1 for r in results if r['recommendation'] == 'HOT')
      good = sum(1 for r in results if r['recommendation'] == 'GOOD')
      
      print(f"\nüìä MATCHING RESULTS")
      print(f"   üî• HOT:  {hot}")
      print(f"   ‚úÖ GOOD: {good}")
      print(f"   Total:  {len(results)}")
      
      for r in results[:10]:
          print(f"\n[{r['score']}%] {r['project']['title'][:50]}...")
          print(f"   ‚Üí {r['profile_name']}")
      
      with open("output/matches.json", "w") as f:
          json.dump(results, f, indent=2, ensure_ascii=False)
      
      print(f"\n‚úÖ {len(results)} matches saved to output/matches.json")
      EOFPY
  artifacts:
    paths:
      - output/matches.json
    expire_in: 7 days

# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
#  STAGE 3: CREATE GMAIL DRAFTS
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

applications:drafts:
  stage: deploy
  tags:
    - mac-group-shell
  needs:
    - job: applications:match
      artifacts: true
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule" && $APPLICATIONS_PIPELINE == "true"
    - if: $APPLICATIONS_DRAFTS == "true"
    - when: manual
      allow_failure: true
  variables:
    MAX_DRAFTS: "5"
  script:
    - pip3 install requests --quiet --break-system-packages 2>/dev/null || pip3 install requests --quiet
    - |
      python3 << 'EOFPY'
      import os
      import json
      import base64
      import requests
      
      # OAuth credentials from CI variables
      CLIENT_ID = os.environ.get("GMAIL_CLIENT_ID")
      CLIENT_SECRET = os.environ.get("GMAIL_CLIENT_SECRET")
      REFRESH_TOKEN = os.environ.get("GMAIL_REFRESH_TOKEN")
      
      if not all([CLIENT_ID, CLIENT_SECRET, REFRESH_TOKEN]):
          print("‚ö†Ô∏è  Gmail credentials not configured")
          print("   Set GMAIL_CLIENT_ID, GMAIL_CLIENT_SECRET, GMAIL_REFRESH_TOKEN")
          exit(0)
      
      max_drafts = int(os.environ.get("MAX_DRAFTS", "5"))
      
      # Load matches
      with open("output/matches.json") as f:
          matches = json.load(f)
      
      matches = matches[:max_drafts]
      
      if not matches:
          print("‚ÑπÔ∏è  No matches to process")
          exit(0)
      
      # Get access token
      resp = requests.post("https://oauth2.googleapis.com/token", data={
          "client_id": CLIENT_ID,
          "client_secret": CLIENT_SECRET,
          "refresh_token": REFRESH_TOKEN,
          "grant_type": "refresh_token"
      })
      
      if resp.status_code != 200:
          print(f"‚ùå Token error: {resp.text}")
          exit(1)
      
      access_token = resp.json()["access_token"]
      print("‚úÖ Got access token")
      
      # Create drafts
      created = 0
      for i, match in enumerate(matches, 1):
          project = match['project']
          profile = match['profile_name']
          
          # Generate email
          subject = f"Bewerbung: {project['title'][:60]}"
          body = f"""Sehr geehrte Damen und Herren,

mit gro√üem Interesse habe ich Ihre Ausschreibung "{project['title']}" gesehen.

Match: {match['score']}% f√ºr Profil "{profile}"
Keywords: {', '.join(match.get('matches', {}).get('must_have', [])[:5])}

Projekt: {project['url']}

Verf√ºgbarkeit: Ab sofort, 100% Remote
Stundensatz: 105 EUR

Mit freundlichen Gr√º√üen,
Wolfram Laube
+43 664 4011521 | wolfram.laube@blauweiss-edv.at"""
          
          raw_email = f"To: \r\nSubject: {subject}\r\nContent-Type: text/plain; charset=utf-8\r\n\r\n{body}"
          raw_b64 = base64.urlsafe_b64encode(raw_email.encode()).decode()
          
          resp = requests.post(
              "https://gmail.googleapis.com/gmail/v1/users/me/drafts",
              headers={"Authorization": f"Bearer {access_token}", "Content-Type": "application/json"},
              json={"message": {"raw": raw_b64}}
          )
          
          if resp.status_code in (200, 201):
              created += 1
              print(f"[{i}/{len(matches)}] ‚úÖ {match['recommendation']} {match['score']}%: {project['title'][:40]}...")
          else:
              print(f"[{i}/{len(matches)}] ‚ùå Failed: {resp.text[:100]}")
      
      print(f"\nüéâ {created}/{len(matches)} Gmail drafts created!")
      print("üëâ Check Gmail ‚Üí Drafts")
      EOFPY

# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
#  MANUAL: FULL PIPELINE (DRY RUN)
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

applications:dry-run:
  stage: .pre
  tags:
    - mac-group-shell
  rules:
    - when: manual
  script:
    - pip3 install requests beautifulsoup4 lxml --quiet --break-system-packages 2>/dev/null || true
    - |
      echo "üîç DRY RUN: Testing pipeline..."
      echo ""
      echo "1. Would crawl: DevOps, Python, AI, Java"
      echo "2. Would match against: Wolfram, Ian, Michael, Teams"
      echo "3. Would create Gmail drafts"
      echo ""
      echo "To run for real:"
      echo "  ‚Üí Set APPLICATIONS_PIPELINE=true in schedule"
      echo "  ‚Üí Or trigger individual jobs manually"
