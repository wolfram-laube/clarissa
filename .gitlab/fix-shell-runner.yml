# Fix GCP Shell Runner via Docker-in-Docker

fix-gcp-shell-via-docker:
  stage: test
  tags:
    - gcp-docker
  image: docker:24-dind
  services:
    - docker:24-dind
  variables:
    DOCKER_TLS_CERTDIR: ""
    DOCKER_HOST: tcp://docker:2375
  when: manual
  allow_failure: true
  script:
    - echo "=== Docker-in-Docker Fix for GCP Shell Runner ==="
    - sleep 5
    - docker version || echo "Waiting for DinD..."
    - sleep 5
    - docker run --rm --privileged -v /:/host alpine:latest sh -c "echo 'case \$- in *i*) ;; *) return;; esac' > /host/home/gitlab-runner/.bashrc && echo 'Fixed!' && cat /host/home/gitlab-runner/.bashrc"
