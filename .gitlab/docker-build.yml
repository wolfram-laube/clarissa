# Docker Build & Push Pipeline
# Builds CLARISSA API image and pushes to GitLab Container Registry
#
# Triggers:
#   - Push to main branch
#   - Semantic version tags (v1.0.0, etc.)
#   - Manual trigger via web
#
# Registry: registry.gitlab.com/wolfram_laube/blauweiss_llc/irena/api

# ============== Build Job ==============
docker-build:
  stage: build
  image: docker:24-dind
  # Use GitLab shared runners (no tags = any runner)
  services:
    - docker:24-dind
  variables:
    DOCKER_HOST: tcp://docker:2376
    DOCKER_TLS_CERTDIR: "/certs"
    DOCKER_TLS_VERIFY: 1
    DOCKER_CERT_PATH: "$DOCKER_TLS_CERTDIR/client"
    API_IMAGE: ${CI_REGISTRY_IMAGE}/api
    DOCKER_BUILDKIT: 1
  before_script:
    - echo "Logging into GitLab Container Registry..."
    - echo "$CI_REGISTRY_PASSWORD" | docker login -u "$CI_REGISTRY_USER" --password-stdin $CI_REGISTRY
  script:
    - echo "Building CLARISSA API image..."
    - export TAGS="-t ${API_IMAGE}:${CI_COMMIT_SHORT_SHA}"
    - if [ "$CI_COMMIT_BRANCH" = "main" ]; then export TAGS="$TAGS -t ${API_IMAGE}:latest"; fi
    - if [ -n "$CI_COMMIT_TAG" ]; then export TAGS="$TAGS -t ${API_IMAGE}:${CI_COMMIT_TAG}"; fi
    - echo "Tags:$TAGS"
    - docker build --build-arg BUILDKIT_INLINE_CACHE=1 --cache-from ${API_IMAGE}:latest -f docker/api/Dockerfile $TAGS .
    - echo "Pushing images to registry..."
    - docker push ${API_IMAGE} --all-tags
    - echo "Docker build complete! Image - ${API_IMAGE}:${CI_COMMIT_SHORT_SHA}"
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
      when: always
    - if: '$CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+$/'
      when: always
    - if: '$CI_PIPELINE_SOURCE == "web"'
      when: manual
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      when: never

# ============== Test Image Job ==============
docker-test:
  stage: test
  image: ${CI_REGISTRY_IMAGE}/api:${CI_COMMIT_SHORT_SHA}
  # Use GitLab shared runners (no tags = any runner)
  needs:
    - docker-build
  script:
    - echo "Testing CLARISSA API image..."
    - python -c "from clarissa.api.main import app; print('Import OK')"
    - echo "Image test passed!"
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
      when: always
    - if: '$CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+$/'
      when: always
    - if: '$CI_PIPELINE_SOURCE == "web"'
      when: manual
