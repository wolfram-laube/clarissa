# Docker Build & Push Pipeline
# Builds CLARISSA API image and pushes to GitLab Container Registry
#
# Triggers:
#   - Push to main branch
#   - Semantic version tags (v1.0.0, etc.)
#   - Manual trigger via web
#
# Registry: registry.gitlab.com/wolfram_laube/blauweiss_llc/irena/api

# ============== Variables ==============
variables:
  DOCKER_HOST: tcp://docker:2376
  DOCKER_TLS_CERTDIR: "/certs"
  DOCKER_TLS_VERIFY: 1
  DOCKER_CERT_PATH: "$DOCKER_TLS_CERTDIR/client"
  # Image names
  API_IMAGE: ${CI_REGISTRY_IMAGE}/api
  # Build args
  DOCKER_BUILDKIT: 1

# ============== Build Job ==============
docker-build:
  stage: build
  image: docker:24-dind
  tags:
    - docker-any
  services:
    - docker:24-dind
  before_script:
    - echo "Logging into GitLab Container Registry..."
    - echo "$CI_REGISTRY_PASSWORD" | docker login -u "$CI_REGISTRY_USER" --password-stdin $CI_REGISTRY
  script:
    - echo "Building CLARISSA API image..."
    - |
      # Determine tags
      TAGS="-t ${API_IMAGE}:${CI_COMMIT_SHORT_SHA}"
      
      # Add 'latest' tag for main branch
      if [ "$CI_COMMIT_BRANCH" = "main" ]; then
        TAGS="$TAGS -t ${API_IMAGE}:latest"
      fi
      
      # Add version tag for semantic version tags
      if [ -n "$CI_COMMIT_TAG" ]; then
        TAGS="$TAGS -t ${API_IMAGE}:${CI_COMMIT_TAG}"
      fi
      
      echo "Tags: $TAGS"
    - |
      # Build image
      docker build \
        --build-arg BUILDKIT_INLINE_CACHE=1 \
        --cache-from ${API_IMAGE}:latest \
        -f docker/api/Dockerfile \
        $TAGS \
        .
    - echo "Pushing images to registry..."
    - docker push ${API_IMAGE} --all-tags
    - echo "✅ Docker build complete!"
    - echo "Image: ${API_IMAGE}:${CI_COMMIT_SHORT_SHA}"
  rules:
    # Build on main branch
    - if: '$CI_COMMIT_BRANCH == "main"'
      when: always
    # Build on version tags
    - if: '$CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+$/'
      when: always
    # Allow manual trigger
    - if: '$CI_PIPELINE_SOURCE == "web"'
      when: manual
    # Skip for MRs (optional: enable for MR testing)
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      when: never

# ============== Test Image Job ==============
docker-test:
  stage: test
  image: ${API_IMAGE}:${CI_COMMIT_SHORT_SHA}
  tags:
    - docker-any
  needs:
    - docker-build
  script:
    - echo "Testing CLARISSA API image..."
    - python -c "from clarissa.api.main import app; print('✅ Import OK')"
    - echo "✅ Image test passed!"
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
      when: always
    - if: '$CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+$/'
      when: always
    - if: '$CI_PIPELINE_SOURCE == "web"'
      when: manual
