# Terraform CI/CD Pipeline
#
# Triggers:
#   - MRs that change infrastructure/** → validate + plan
#   - Push to main with infrastructure/** changes → plan + apply (manual)
#
# Required CI Variables:
#   - GOOGLE_CREDENTIALS: GCP Service Account JSON key
#   - TF_VAR_gcp_project: GCP Project ID
#   - TF_VAR_openai_api_key: OpenAI API Key
#   - TF_VAR_anthropic_api_key: Anthropic API Key (optional)

variables:
  TF_ROOT: ${CI_PROJECT_DIR}/infrastructure/terraform/environments/gcp
  TF_STATE_NAME: gcp-${CI_ENVIRONMENT_NAME}
  # Use GitLab managed Terraform state
  TF_ADDRESS: ${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/terraform/state/${TF_STATE_NAME}

.terraform-base:
  image:
    name: hashicorp/terraform:1.7
    entrypoint: [""]
  tags:
    - docker-any
  before_script:
    - cd ${TF_ROOT}
    # Setup GCP credentials
    - |
      if [ -n "$GOOGLE_CREDENTIALS" ]; then
        echo "$GOOGLE_CREDENTIALS" > /tmp/gcp-key.json
        export GOOGLE_APPLICATION_CREDENTIALS=/tmp/gcp-key.json
      fi
    # Configure GitLab-managed Terraform state backend
    - |
      cat > backend.tf << BACKEND
      terraform {
        backend "http" {
          address        = "${TF_ADDRESS}"
          lock_address   = "${TF_ADDRESS}/lock"
          unlock_address = "${TF_ADDRESS}/lock"
          username       = "gitlab-ci-token"
          password       = "${CI_JOB_TOKEN}"
          lock_method    = "POST"
          unlock_method  = "DELETE"
          retry_wait_min = 5
        }
      }
      BACKEND
    - terraform --version
    - terraform init

# ============================================================
# Validation Stage - runs on all MRs
# ============================================================

terraform:fmt:
  extends: .terraform-base
  stage: test
  script:
    - terraform fmt -check -recursive -diff
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      changes:
        - infrastructure/terraform/**/*
    - if: '$CI_COMMIT_BRANCH == "main"'
      changes:
        - infrastructure/terraform/**/*
  allow_failure: true  # Formatting is advisory

terraform:validate:
  extends: .terraform-base
  stage: test
  script:
    - terraform validate
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      changes:
        - infrastructure/terraform/**/*
    - if: '$CI_COMMIT_BRANCH == "main"'
      changes:
        - infrastructure/terraform/**/*

# ============================================================
# Plan Stage - shows what would change
# ============================================================

terraform:plan:
  extends: .terraform-base
  stage: build
  script:
    - terraform plan -out=plan.tfplan
    - terraform show -no-color plan.tfplan > plan.txt
  artifacts:
    name: "terraform-plan-${CI_COMMIT_SHORT_SHA}"
    paths:
      - ${TF_ROOT}/plan.tfplan
      - ${TF_ROOT}/plan.txt
    expire_in: 7 days
    reports:
      terraform: ${TF_ROOT}/plan.json
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      changes:
        - infrastructure/terraform/**/*
    - if: '$CI_COMMIT_BRANCH == "main"'
      changes:
        - infrastructure/terraform/**/*
  after_script:
    - cd ${TF_ROOT}
    # Generate JSON for GitLab Terraform report
    - terraform show -json plan.tfplan > plan.json || true
    # Summary in job output
    - echo "=== Terraform Plan Summary ==="
    - grep -E "^(Plan:|No changes)" plan.txt || echo "See plan.txt artifact for details"

# ============================================================
# Apply Stage - only on main, manual trigger
# ============================================================

terraform:apply:
  extends: .terraform-base
  stage: deploy
  script:
    - terraform apply -auto-approve plan.tfplan
  dependencies:
    - terraform:plan
  environment:
    name: gcp-production
    url: https://clarissa-api-${TF_VAR_gcp_project}.run.app
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
      changes:
        - infrastructure/terraform/**/*
      when: manual
  allow_failure: false

# ============================================================
# Destroy Stage - emergency use only
# ============================================================

terraform:destroy:
  extends: .terraform-base
  stage: deploy
  script:
    - terraform destroy -auto-approve
  environment:
    name: gcp-production
    action: stop
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
      when: manual
  allow_failure: false
  when: manual
