# Gmail Draft Creation Pipeline

gmail:create-drafts:
  stage: .pre
  tags:
    - mac-group-shell
  rules:
    - if: $DRAFTS_JSON
      when: always
    - when: manual
      allow_failure: true
  script:
    - pip3 install requests --quiet --break-system-packages || pip3 install requests --quiet --user || true
    - |
      python3 - << 'PYSCRIPT'
      import os, json, base64, requests

      CLIENT_ID = os.environ["GMAIL_CLIENT_ID"]
      CLIENT_SECRET = os.environ["GMAIL_CLIENT_SECRET"]
      REFRESH_TOKEN = os.environ["GMAIL_REFRESH_TOKEN"]
      DRAFTS_JSON = os.environ.get("DRAFTS_JSON", "[]")

      response = requests.post(
          "https://oauth2.googleapis.com/token",
          data={"client_id": CLIENT_ID, "client_secret": CLIENT_SECRET,
                "refresh_token": REFRESH_TOKEN, "grant_type": "refresh_token"}
      )
      access_token = response.json()["access_token"]
      print("Got access token")

      drafts = json.loads(DRAFTS_JSON) if DRAFTS_JSON else []
      print(f"Creating {len(drafts)} drafts...")

      for i, draft in enumerate(drafts):
          to_addr = draft.get("to", "")
          subject = draft.get("subject", "")
          body = draft.get("body", "")
          email = f"From: wolfram.laube@blauweiss-edv.at\r\nTo: {to_addr}\r\nSubject: {subject}\r\nContent-Type: text/plain; charset=utf-8\r\n\r\n{body}"
          raw = base64.urlsafe_b64encode(email.encode()).decode()
          resp = requests.post(
              "https://gmail.googleapis.com/gmail/v1/users/me/drafts",
              headers={"Authorization": f"Bearer {access_token}"},
              json={"message": {"raw": raw}}
          )
          status = "OK" if resp.status_code == 200 else f"FAIL {resp.status_code}"
          print(f"  Draft {i+1}: {status} - {subject[:50]}")
      PYSCRIPT
