# Gmail Draft Creation Pipeline
# Trigger via API with DRAFTS_JSON variable

gmail:create-drafts:
  stage: .pre
  tags:
    - mac-group-shell
  rules:
    - if: $DRAFTS_JSON
      when: always
    - when: manual
      allow_failure: true
  script:
    - pip3 install requests --quiet --user
    - |
      cat > /tmp/create_drafts.py << 'ENDSCRIPT'
      import os, json, base64
      import requests

      CLIENT_ID = os.environ["GMAIL_CLIENT_ID"]
      CLIENT_SECRET = os.environ["GMAIL_CLIENT_SECRET"]  
      REFRESH_TOKEN = os.environ["GMAIL_REFRESH_TOKEN"]
      DRAFTS_JSON = os.environ.get("DRAFTS_JSON", "[]")

      response = requests.post(
          "https://oauth2.googleapis.com/token",
          data={"client_id": CLIENT_ID, "client_secret": CLIENT_SECRET,
                "refresh_token": REFRESH_TOKEN, "grant_type": "refresh_token"}
      )
      access_token = response.json()["access_token"]
      print("Got access token")

      drafts = json.loads(DRAFTS_JSON) if DRAFTS_JSON else []
      print(f"Creating {len(drafts)} drafts...")

      for i, draft in enumerate(drafts):
          email = f"""From: wolfram.laube@blauweiss-edv.at
To: {draft.get('to', '')}
Subject: {draft.get('subject', '')}
Content-Type: text/plain; charset=utf-8

{draft.get('body', '')}
"""
          raw = base64.urlsafe_b64encode(email.encode()).decode()
          response = requests.post(
              "https://gmail.googleapis.com/gmail/v1/users/me/drafts",
              headers={"Authorization": f"Bearer {access_token}"},
              json={"message": {"raw": raw}}
          )
          status = "OK" if response.status_code == 200 else f"FAIL {response.status_code}"
          print(f"  Draft {i+1}: {status} - {draft.get('subject', '')[:50]}")
      ENDSCRIPT
    - python3 /tmp/create_drafts.py
