# Gmail Draft Creation Pipeline
#
# Usage: Set DRAFTS_JSON_B64 variable (base64 encoded JSON array of drafts)
# Example: [{"to":"email@example.com","subject":"Subject","body":"Body"}]

gmail:create-drafts:
  stage: .pre
  tags:
    - mac-group-shell
  rules:
    - if: $DRAFTS_JSON_B64
      when: always
    - when: manual
      allow_failure: true
  script:
    - pip3 install requests --quiet --break-system-packages || pip3 install requests --quiet --user || true
    - |
      python3 << 'EOF'
      import os, json, base64, requests, sys

      CLIENT_ID = os.environ["GMAIL_CLIENT_ID"]
      CLIENT_SECRET = os.environ["GMAIL_CLIENT_SECRET"]
      REFRESH_TOKEN = os.environ["GMAIL_REFRESH_TOKEN"]
      DRAFTS_B64 = os.environ.get("DRAFTS_JSON_B64", "")

      if not DRAFTS_B64:
          print("No DRAFTS_JSON_B64 provided")
          sys.exit(0)

      try:
          drafts_json = base64.b64decode(DRAFTS_B64).decode("utf-8")
          drafts = json.loads(drafts_json)
          print(f"Decoded {len(drafts)} draft(s)")
      except Exception as e:
          print(f"Decode error: {e}")
          sys.exit(1)

      response = requests.post(
          "https://oauth2.googleapis.com/token",
          data={"client_id": CLIENT_ID, "client_secret": CLIENT_SECRET,
                "refresh_token": REFRESH_TOKEN, "grant_type": "refresh_token"}
      )
      if response.status_code != 200:
          print(f"Token error: {response.text}")
          sys.exit(1)
      access_token = response.json()["access_token"]
      print("Got access token")

      success = 0
      for i, draft in enumerate(drafts):
          to_addr = draft.get("to", "")
          subject = draft.get("subject", "")
          body = draft.get("body", "")
          cc = draft.get("cc", "")
          
          headers = ["From: wolfram.laube@blauweiss-edv.at", f"To: {to_addr}"]
          if cc:
              headers.append(f"Cc: {cc}")
          headers.extend([f"Subject: {subject}", "Content-Type: text/plain; charset=utf-8", "MIME-Version: 1.0"])
          
          email = "\r\n".join(headers) + "\r\n\r\n" + body
          raw = base64.urlsafe_b64encode(email.encode()).decode()
          
          resp = requests.post(
              "https://gmail.googleapis.com/gmail/v1/users/me/drafts",
              headers={"Authorization": f"Bearer {access_token}"},
              json={"message": {"raw": raw}}
          )
          
          if resp.status_code == 200:
              print(f"Draft {i+1}: OK - {subject[:40]}")
              success += 1
          else:
              print(f"Draft {i+1}: FAIL - {resp.status_code}")

      print(f"Created {success}/{len(drafts)} drafts")
      if success < len(drafts):
          sys.exit(1)
      EOF

gmail:benchmark-report:
  stage: .pre
  tags:
    - mac-group-shell
  rules:
    - if: $BENCHMARK_EMAIL == "true"
      when: always
    - when: manual
      allow_failure: true
  variables:
    BENCHMARK_TO: "wolfram.laube@blauweiss-edv.at"
  script:
    - pip3 install requests --quiet --break-system-packages || pip3 install requests --quiet --user || true
    - |
      python3 << 'EOF'
      import os, base64, requests, sys
      from datetime import datetime

      CLIENT_ID = os.environ["GMAIL_CLIENT_ID"]
      CLIENT_SECRET = os.environ["GMAIL_CLIENT_SECRET"]
      REFRESH_TOKEN = os.environ["GMAIL_REFRESH_TOKEN"]
      TO = os.environ.get("BENCHMARK_TO", "wolfram.laube@blauweiss-edv.at")
      PIPELINE_URL = os.environ.get("CI_PIPELINE_URL", "")

      subject = "[CLARISSA] GitLab Runner Benchmark Report"
      body = "Hallo,\n\nder GitLab Runner Benchmark wurde ausgefuehrt.\n\n"
      body += f"Pipeline: {PIPELINE_URL}\n"
      body += f"Zeitpunkt: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}\n\n"
      body += "Report im Repository:\n"
      body += "https://gitlab.com/wolfram_laube/blauweiss_llc/irena/-/tree/main/docs/ci/benchmarks\n\n"
      body += "Beste Gruesse,\nCLARISSA CI/CD"

      response = requests.post(
          "https://oauth2.googleapis.com/token",
          data={"client_id": CLIENT_ID, "client_secret": CLIENT_SECRET,
                "refresh_token": REFRESH_TOKEN, "grant_type": "refresh_token"}
      )
      access_token = response.json()["access_token"]
      print("Got access token")

      email = f"From: wolfram.laube@blauweiss-edv.at\r\nTo: {TO}\r\nSubject: {subject}\r\nContent-Type: text/plain; charset=utf-8\r\n\r\n{body}"
      raw = base64.urlsafe_b64encode(email.encode()).decode()

      resp = requests.post(
          "https://gmail.googleapis.com/gmail/v1/users/me/drafts",
          headers={"Authorization": f"Bearer {access_token}"},
          json={"message": {"raw": raw}}
      )

      if resp.status_code == 200:
          print("Benchmark report draft created")
      else:
          print(f"Failed: {resp.text}")
          sys.exit(1)
      EOF
