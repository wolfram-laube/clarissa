# =============================================================================
# PAGES: Documentation, Portal & Publications
# =============================================================================
# MkDocs site, Operations Portal, Conference Papers
# =============================================================================

# -----------------------------------------------------------------------------
# TEST STAGE: Validation
# -----------------------------------------------------------------------------
mkdocs_nav_check:
  stage: test
  image: python:3.11-slim
  tags:
    - docker-any
  script:
    - pip install pyyaml -q
    - python scripts/check_mkdocs_nav.py
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    - if: '$CI_COMMIT_BRANCH == "main" && $CI_PIPELINE_SOURCE == "push"'
    - when: never

# -----------------------------------------------------------------------------
# BUILD STAGE: Conference Papers
# -----------------------------------------------------------------------------
build_paper:
  stage: build
  image: texlive/texlive:latest
  tags:
    - docker
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      changes:
        - conference/**/*
      when: on_success
    - if: '$CI_COMMIT_BRANCH == "main" && $CI_PIPELINE_SOURCE == "push"'
      changes:
        - conference/**/*
      when: on_success
    - if: '$CI_PIPELINE_SOURCE == "web"'
      when: manual
    - when: never
  script:
    - cd conference/ijacsa-2026
    - echo "Copying figures to build directory..."
    - cp figures/*.png . 2>/dev/null || echo "No figures to copy"
    - ls -la *.png 2>/dev/null || echo "No PNG files found"
    - echo "Building CLARISSA paper..."
    - pdflatex -interaction=nonstopmode CLARISSA_Paper_IJACSA.tex || true
    - pdflatex -interaction=nonstopmode CLARISSA_Paper_IJACSA.tex
    - echo "‚úÖ Paper built successfully"
    - ls -la *.pdf
  artifacts:
    paths:
      - conference/ijacsa-2026/CLARISSA_Paper_IJACSA.pdf
    expire_in: 4 weeks

render_diagrams:
  stage: build
  image: minlag/mermaid-cli:latest
  tags:
    - docker
  rules:
    - if: '$CI_COMMIT_BRANCH == "main" && $CI_PIPELINE_SOURCE == "push"'
      changes:
        - "conference/spe-europe-2026/diagrams/*.mmd"
    - if: '$CI_PIPELINE_SOURCE == "web"'
      when: manual
      allow_failure: true
    - when: never
  script:
    - cd conference/spe-europe-2026/diagrams
    - |
      echo "üé® Rendering Mermaid diagrams..."
      for mmd in *.mmd; do
        name="${mmd%.mmd}"
        echo "   Processing $mmd..."
        mmdc -i "$mmd" -o "${name}.svg" -b transparent || echo "SVG failed for $mmd"
        mmdc -i "$mmd" -o "${name}.png" -s 2 -b white || echo "PNG failed for $mmd"
      done
    - ls -la *.svg *.png 2>/dev/null || echo "No outputs"
  artifacts:
    paths:
      - conference/spe-europe-2026/diagrams/*.svg
      - conference/spe-europe-2026/diagrams/*.png
    expire_in: 4 weeks

build_canonical_html:
  stage: build
  image: python:3.11-slim
  tags:
    - docker
  rules:
    - if: '$CI_COMMIT_BRANCH == "main" && $CI_PIPELINE_SOURCE == "push"'
      changes:
        - "conference/spe-europe-2026/canonical/**/*"
        - "conference/spe-europe-2026/scripts/*.py"
    - if: '$CI_PIPELINE_SOURCE == "web"'
      when: manual
      allow_failure: true
    - when: never
  script:
    - python conference/spe-europe-2026/scripts/build_canonical.py
    - ls -la conference/spe-europe-2026/outputs/
  artifacts:
    paths:
      - conference/spe-europe-2026/outputs/*.html
    expire_in: 4 weeks

build_canonical_pdf:
  stage: test
  image: node:20-alpine
  tags:
    - docker
  needs:
    - job: build_canonical_html
      artifacts: true
  rules:
    - if: '$CI_COMMIT_BRANCH == "main" && $CI_PIPELINE_SOURCE == "push"'
      changes:
        - "conference/spe-europe-2026/canonical/**/*"
        - "conference/spe-europe-2026/scripts/*.py"
    - if: '$CI_PIPELINE_SOURCE == "web"'
      when: manual
      allow_failure: true
    - when: never
  before_script:
    - apk add --no-cache chromium
    - npm install puppeteer
    - export PUPPETEER_EXECUTABLE_PATH=/usr/bin/chromium-browser
  script:
    - |
      cat > generate-pdfs.js << 'JSEOF'
      const puppeteer = require('puppeteer');
      const fs = require('fs');
      const path = require('path');

      (async () => {
        const browser = await puppeteer.launch({
          headless: 'new',
          executablePath: process.env.PUPPETEER_EXECUTABLE_PATH,
          args: ['--no-sandbox', '--disable-setuid-sandbox', '--disable-dev-shm-usage', '--disable-gpu']
        });
        
        const outputDir = 'conference/spe-europe-2026/outputs';
        const htmlFiles = fs.readdirSync(outputDir).filter(f => f.endsWith('.html'));
        
        let success = 0, failed = 0;
        
        for (const htmlFile of htmlFiles) {
          const pdfFile = htmlFile.replace('.html', '.pdf');
          console.log('Converting ' + htmlFile + ' to ' + pdfFile);
          
          try {
            const page = await browser.newPage();
            page.setDefaultTimeout(120000);
            page.setDefaultNavigationTimeout(120000);
            
            const html = fs.readFileSync(path.join(outputDir, htmlFile), 'utf8');
            
            console.log('   Loading HTML...');
            await page.setContent(html, { 
              waitUntil: 'domcontentloaded',
              timeout: 90000 
            });
            
            const hasMermaid = await page.evaluate(() => 
              document.querySelectorAll('.mermaid').length > 0
            );
            
            if (hasMermaid) {
              console.log('   Waiting for Mermaid.js to render diagrams...');
              try {
                await page.waitForFunction(() => {
                  const divs = document.querySelectorAll('.mermaid');
                  return Array.from(divs).every(d => d.querySelector('svg'));
                }, { timeout: 60000 });
                console.log('   Mermaid diagrams rendered');
              } catch (e) {
                console.log('   Mermaid timeout - diagrams may be missing');
              }
            }
            
            await new Promise(r => setTimeout(r, 1500));
            
            console.log('   Generating PDF...');
            await page.pdf({
              path: path.join(outputDir, pdfFile),
              format: 'A4',
              margin: { top: '2cm', right: '2cm', bottom: '2cm', left: '2cm' },
              printBackground: true
            });
            
            await page.close();
            console.log('   ' + pdfFile + ' created');
            success++;
            
          } catch (err) {
            console.error('   Failed: ' + err.message);
            failed++;
          }
        }
        
        await browser.close();
        console.log('Results: ' + success + ' success, ' + failed + ' failed');
        
        if (failed > 0 && success === 0) {
          process.exit(1);
        }
      })();
      JSEOF
    - node generate-pdfs.js
    - ls -la conference/spe-europe-2026/outputs/
  artifacts:
    paths:
      - conference/spe-europe-2026/outputs/*.pdf
      - conference/spe-europe-2026/outputs/*.html
    expire_in: 4 weeks
    name: "spe-canonical-${CI_COMMIT_SHORT_SHA}"

# -----------------------------------------------------------------------------
# DEPLOY STAGE: GitLab Pages
# -----------------------------------------------------------------------------
pages:
  stage: deploy
  image: python:3.11
  tags:
    - docker-any
  needs: []
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
      when: always
    - when: never
  before_script:
    - pip install mkdocs mkdocs-material pymdown-extensions jinja2 pyyaml mkdocs-jupyter
    - apt-get update -qq && apt-get install -y -qq nodejs npm
  script:
    - mkdir -p docs/architecture/rendered
    - cp docs/architecture/rendered/*.svg docs/architecture/rendered/ 2>/dev/null || echo "No rendered architecture diagrams from CI"
    - ls -la docs/architecture/rendered/ || true
    - python scripts/build_i18n_docs.py
    - mkdocs build --site-dir public
    # Pagefind search index
    - npm install -g pagefind
    - pagefind --site public
    - mkdir -p public/guides/contributing
    - cp docs/guides/contributing/*.html public/guides/contributing/ 2>/dev/null || true
    # Publications setup
    - echo "üìÑ Setting up publication PDFs..."
    - mkdir -p public/publications/ijacsa-2026 public/publications/spe-europe-2026
    - cp conference/ijacsa-2026/CLARISSA_Paper_IJACSA.pdf public/publications/ijacsa-2026/ 2>/dev/null || echo "IJACSA PDF not in artifacts"
    - cp conference/spe-europe-2026/outputs/*.pdf public/publications/spe-europe-2026/ 2>/dev/null || echo "No canonical PDFs"
    - cp conference/spe-europe-2026/outputs/*.html public/publications/spe-europe-2026/ 2>/dev/null || echo "No canonical HTMLs"
    - cp conference/spe-europe-2026/abstract-with-diagrams.pdf public/publications/spe-europe-2026/ 2>/dev/null || true
    - cp conference/spe-europe-2026/abstract-corrected-v2.html public/publications/spe-europe-2026/ 2>/dev/null || true
    # Architecture diagrams
    - mkdir -p public/architecture/rendered
    - cp docs/architecture/rendered/index.html public/architecture/rendered/ 2>/dev/null || true
    # Publications index
    - |
      cat > public/publications/index.html << 'PUBHTML'
      <!DOCTYPE html>
      <html><head><title>CLARISSA Publications</title>
      <style>
      body{font-family:sans-serif;max-width:900px;margin:50px auto;padding:20px}
      h1{color:#1a365d}
      .conf{background:#f7fafc;padding:20px;margin:20px 0;border-radius:8px;border-left:4px solid #3182ce}
      .conf h2{margin-top:0;color:#2c5282}
      a{color:#3182ce}
      .docs{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;margin-top:15px}
      .doc{background:white;padding:15px;border-radius:4px;border:1px solid #e2e8f0}
      .doc a{font-weight:bold}
      </style></head><body>
      <h1>üìö CLARISSA Publications</h1>
      <p>Review copies for internal distribution.</p>
      
      <div class="conf"><h2>IJACSA 2026</h2>
      <p>International Journal of Advanced Computer Science and Applications</p>
      <div class="docs">
        <div class="doc"><a href="ijacsa-2026/CLARISSA_Paper_IJACSA.pdf">üìÑ Full Paper (PDF)</a><br><small>8 pages, all figures</small></div>
      </div></div>
      
      <div class="conf"><h2>SPE Europe Energy Conference 2026</h2>
      <p>Category: Digital Transformation and AI</p>
      <div class="docs">
        <div class="doc"><a href="spe-europe-2026/CLARISSA_SPE_Abstract.pdf">üìÑ Abstract (PDF)</a><br><small>Conference submission</small></div>
        <div class="doc"><a href="spe-europe-2026/abstract-with-diagrams.pdf">üìÑ Full Paper (PDF)</a><br><small>With Mermaid diagrams</small></div>
        <div class="doc"><a href="spe-europe-2026/abstract-corrected-v2.html">üåê Full Paper (HTML)</a><br><small>Interactive version</small></div>
      </div></div>
      
      <p style="margin-top:40px;color:#718096;font-size:0.9em">
      Groundtruth: <code>conference/spe-europe-2026/canonical/</code>
      </p>
      </body></html>
      PUBHTML
    - echo "üìÅ Publications deployed:"
    - find public/publications -type f
  artifacts:
    paths:
      - public
    expire_in: 1 week

rebuild_docs:
  stage: deploy
  image: python:3.11
  tags:
    - docker-any
  rules:
    - if: '$CI_PIPELINE_SOURCE == "web"'
      when: manual
    - when: never
  before_script:
    - pip install mkdocs mkdocs-material pymdown-extensions jinja2 pyyaml mkdocs-jupyter
  script:
    - echo "Rebuilding documentation..."
    - python scripts/build_i18n_docs.py
    - mkdocs build --site-dir public
    - |
      mkdir -p public/guides/contributing
      cp docs/guides/contributing/*.html public/guides/contributing/ 2>/dev/null || true
  artifacts:
    paths:
      - public
    expire_in: 1 day
  environment:
    name: docs-preview
    url: https://wolfram_laube.gitlab.io/blauweiss_llc/projects/clarissa/

docs:preview:
  stage: deploy
  image: python:3.11
  tags:
    - docker-any
  needs: []
  rules:
    - if: '$CI_COMMIT_BRANCH != "main"'
      when: manual
    - when: never
  before_script:
    - pip install mkdocs mkdocs-material pymdown-extensions jinja2 pyyaml mkdocs-jupyter
  script:
    - echo "üî® Building documentation preview..."
    - python scripts/build_i18n_docs.py || echo "i18n script not critical"
    - mkdocs build --site-dir public
    - echo "‚úÖ Documentation built successfully!"
    - echo "üì¶ Download artifacts to preview locally"
  artifacts:
    paths:
      - public
    expire_in: 1 week
    name: "docs-preview-${CI_COMMIT_SHORT_SHA}"

# -----------------------------------------------------------------------------
# AUTOMATION STAGE: Document Merge Pipeline
# -----------------------------------------------------------------------------
doc_merge:normalize:
  stage: build
  image: debian:bookworm-slim
  tags:
    - docker
  before_script:
    - apt-get update -qq && apt-get install -y -qq pandoc > /dev/null 2>&1
  rules:
    - if: '$CI_PIPELINE_SOURCE == "push" || $CI_PIPELINE_SOURCE == "merge_request_event"'
      changes:
        - conference/spe-europe-2026/sources/**/*
      when: on_success
    - if: '$CI_PIPELINE_SOURCE == "web" && $DOC_MERGE == "true"'
      when: on_success
    - when: never
  script:
    - |
      mkdir -p normalized
      DOC_PATH="conference/spe-europe-2026/sources"
      
      echo "=== Normalizing DOCX files ==="
      for docx in ${DOC_PATH}/doug/*.docx; do
        [ -f "$docx" ] || continue
        name=$(basename "$docx" .docx)
        echo "Converting: $docx"
        pandoc "$docx" -t markdown -o "normalized/doug-${name}.md" --wrap=none
      done
      
      echo "=== Copying MD files ==="
      for md in ${DOC_PATH}/*/*.md; do
        [ -f "$md" ] || continue
        author=$(basename $(dirname "$md"))
        name=$(basename "$md" .md)
        echo "Copying: $md"
        cp "$md" "normalized/${author}-${name}.md"
      done
      
      echo "=== Normalized files ==="
      ls -la normalized/
  artifacts:
    paths:
      - normalized/
    expire_in: 1 day

doc_merge:compare:
  stage: test
  image: python:3.11-slim
  tags:
    - docker
  needs:
    - job: doc_merge:normalize
      artifacts: true
  rules:
    - if: '$CI_PIPELINE_SOURCE == "push" || $CI_PIPELINE_SOURCE == "merge_request_event"'
      changes:
        - conference/spe-europe-2026/sources/**/*
      when: on_success
    - if: '$CI_PIPELINE_SOURCE == "web" && $DOC_MERGE == "true"'
      when: on_success
    - when: never
  script:
    - pip install --quiet anthropic openai
    - python3 conference/spe-europe-2026/scripts/doc_compare.py normalized/ comparison-report.json
    - echo "=== Comparison Report ==="
    - cat comparison-report.json
  artifacts:
    paths:
      - comparison-report.json
    expire_in: 1 week

doc_merge:merge:
  stage: automation
  image: python:3.11-slim
  tags:
    - docker
  needs:
    - job: doc_merge:normalize
      artifacts: true
    - job: doc_merge:compare
      artifacts: true
  rules:
    - if: '$CI_PIPELINE_SOURCE == "push" || $CI_PIPELINE_SOURCE == "merge_request_event"'
      changes:
        - conference/spe-europe-2026/sources/**/*
      when: manual
    - if: '$CI_PIPELINE_SOURCE == "web" && $DOC_MERGE == "true"'
      when: manual
    - when: never
  script:
    - pip install --quiet anthropic openai
    - python3 conference/spe-europe-2026/scripts/doc_do_merge.py normalized/ merged-output.md merge-log.json
    - echo "=== Merge Log ==="
    - cat merge-log.json
  artifacts:
    paths:
      - merged-output.md
      - merge-log.json
    expire_in: 1 week

doc_merge:generate:
  stage: deploy
  image: node:20-bookworm
  tags:
    - docker
  needs:
    - job: doc_merge:merge
      artifacts: true
  rules:
    - if: '$CI_PIPELINE_SOURCE == "push" || $CI_PIPELINE_SOURCE == "merge_request_event"'
      changes:
        - conference/spe-europe-2026/sources/**/*
      when: on_success
    - if: '$CI_PIPELINE_SOURCE == "web" && $DOC_MERGE == "true"'
      when: on_success
    - when: never
  before_script:
    - apt-get update -qq && apt-get install -y -qq pandoc texlive-xetex texlive-fonts-recommended texlive-latex-extra python3 chromium librsvg2-bin > /dev/null 2>&1
    - npm install -g @mermaid-js/mermaid-cli > /dev/null 2>&1
    - export PUPPETEER_EXECUTABLE_PATH=/usr/bin/chromium
  script:
    - |
      mkdir -p doc-outputs diagrams
      
      if [ ! -f merged-output.md ]; then
        echo "No merged document found"
        exit 1
      fi
      
      echo "=== Rendering Mermaid diagrams to SVG ==="
      python3 conference/spe-europe-2026/scripts/render_mermaid_images.py \
        merged-output.md \
        doc-outputs/for-pdf.md \
        diagrams
      
      echo "=== Generating PDF with rendered diagrams ==="
      cp -r diagrams doc-outputs/
      cd doc-outputs
      pandoc for-pdf.md -o abstract-merged.pdf \
        --pdf-engine=xelatex \
        -V geometry:margin=2.5cm \
        -V fontsize=11pt \
        -V mainfont="DejaVu Serif" \
        -V sansfont="DejaVu Sans" \
        -V monofont="DejaVu Sans Mono" || \
      pandoc for-pdf.md -o abstract-merged.pdf \
        --pdf-engine=pdflatex \
        -V geometry:margin=2.5cm \
        -V fontsize=11pt
      cd ..
      
      echo "=== Generating HTML with Mermaid.js ==="
      python3 conference/spe-europe-2026/scripts/preprocess_mermaid.py \
        merged-output.md \
        doc-outputs/for-html.md
      pandoc doc-outputs/for-html.md -o doc-outputs/abstract-merged.html \
        --standalone \
        --template=conference/spe-europe-2026/templates/mermaid-template.html \
        --metadata title="CLARISSA - SPE Europe 2026"
      
      echo "=== Generating DOCX ==="
      pandoc merged-output.md -o doc-outputs/abstract-merged.docx
      
      echo "=== Copying canonical MD ==="
      cp merged-output.md doc-outputs/abstract-canonical.md
      
      echo "=== Generated files ==="
      ls -la doc-outputs/
      ls -la diagrams/
  artifacts:
    paths:
      - doc-outputs/
      - diagrams/
    expire_in: 4 weeks
