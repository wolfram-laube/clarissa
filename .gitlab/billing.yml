# =============================================================================
# BILLING AUTOMATION: Monthly Invoicing & Timesheets
# =============================================================================
# Schedule: 1st of month at 06:00 Vienna (BILLING_RUN=true)
# Manual: Set FORCE_BILLING=true or GENERATE_TIMESHEETS=true
# =============================================================================

# -----------------------------------------------------------------------------
# BUILD STAGE: Generate Timesheets
# -----------------------------------------------------------------------------
generate_timesheets:
  stage: build
  image: python:3.11-slim
  tags:
    - docker-any
  variables:
    GITLAB_PROJECT_PATH: "wolfram_laube/blauweiss_llc/projects/clarissa"
  rules:
    - if: '$CI_PIPELINE_SOURCE == "schedule" && $BILLING_RUN == "true"'
      when: on_success
    - if: '$CI_PIPELINE_SOURCE == "web" && $GENERATE_TIMESHEETS == "true"'
      when: on_success
    - when: never
  before_script:
    - pip install pyyaml requests -q
  script:
    - |
      echo "=== Monthly Timesheet Generation ==="
      if [ -n "$BILLING_PERIOD" ]; then
        PERIOD="$BILLING_PERIOD"
      else
        PERIOD=$(date -d "last month" +%Y-%m)
      fi
      echo "Period: $PERIOD"
      cd billing/scripts
      for CLIENT in nemensis; do
        echo "--- Client: $CLIENT ---"
        python generate_timesheet.py --client "$CLIENT" --period "$PERIOD" --all-consultants || echo "No entries for $CLIENT"
      done
      ls -la ../output/*.typ 2>/dev/null || echo "No timesheets generated"
  artifacts:
    paths:
      - billing/output/*.typ
      - billing/output/*.sync.json
    expire_in: 8 weeks

# -----------------------------------------------------------------------------
# BUILD STAGE: Compile Invoices with Typst
# -----------------------------------------------------------------------------
build_invoice:
  stage: build
  image: alpine:latest
  tags:
    - docker-any
  needs: []
  rules:
    - if: '$FORCE_BILLING == "true"'
      when: always
    - if: '$CI_COMMIT_BRANCH == "main"'
      changes:
        - billing/templates/**/*
        - billing/output/**/*.typ
      when: always
    - when: never
  before_script:
    - apk add --no-cache curl tar xz fontconfig ttf-liberation
    # Install Poppins font
    - mkdir -p /usr/share/fonts/poppins
    - curl -L "https://github.com/google/fonts/raw/main/ofl/poppins/Poppins-Regular.ttf" -o /usr/share/fonts/poppins/Poppins-Regular.ttf
    - curl -L "https://github.com/google/fonts/raw/main/ofl/poppins/Poppins-Bold.ttf" -o /usr/share/fonts/poppins/Poppins-Bold.ttf
    - curl -L "https://github.com/google/fonts/raw/main/ofl/poppins/Poppins-Medium.ttf" -o /usr/share/fonts/poppins/Poppins-Medium.ttf
    - fc-cache -fv
    # Install Typst
    - curl -L "https://github.com/typst/typst/releases/download/v0.12.0/typst-x86_64-unknown-linux-musl.tar.xz" -o /tmp/typst.tar.xz
    - tar xf /tmp/typst.tar.xz -C /tmp
    - mv /tmp/typst-x86_64-unknown-linux-musl/typst /usr/local/bin/
    - typst --version
  script:
    - echo "Building invoices with Typst..."
    - cd billing
    - cp templates/logo.jpg output/ 2>/dev/null || true
    - |
      cd output
      for f in *.typ; do
        if [ -f "$f" ]; then
          echo "Compiling $f..."
          typst compile --root .. "$f"
        fi
      done
    - echo "‚úÖ Invoices built"
    - ls -la *.pdf 2>/dev/null || echo "No PDFs generated"
  artifacts:
    paths:
      - billing/output/*.pdf
    expire_in: 8 weeks

# -----------------------------------------------------------------------------
# DEPLOY STAGE: Upload to Google Drive
# -----------------------------------------------------------------------------
upload_invoice:
  stage: deploy
  image: python:3.11-slim
  tags:
    - docker-any
  needs:
    - job: build_invoice
      artifacts: true
      optional: true
  rules:
    - if: '$FORCE_BILLING == "true"'
      when: on_success
    - if: '$CI_COMMIT_BRANCH == "main"'
      changes:
        - billing/output/**/*.typ
      when: on_success
    - when: manual
      allow_failure: true
  script:
    - pip install google-auth google-api-python-client -q
    - python billing/scripts/upload_to_drive.py billing/output/*.pdf

# -----------------------------------------------------------------------------
# DEPLOY STAGE: Create Gmail Draft
# -----------------------------------------------------------------------------
billing_email:
  stage: deploy
  image: python:3.11-slim
  tags:
    - docker-any
  needs:
    - job: build_invoice
      artifacts: true
    - job: upload_invoice
      optional: true
  rules:
    - if: '$FORCE_BILLING == "true"'
      when: always
    - if: '$CI_COMMIT_BRANCH == "main"'
      changes:
        - billing/output/**/*.typ
      when: always
    - when: never
  variables:
    BILLING_CLIENT: "nemensis"
    BILLING_PERIOD: ""
  before_script:
    - pip install requests pyyaml -q
  script:
    - |
      # Auto-detect period from latest invoice if not set
      if [ -z "$BILLING_PERIOD" ]; then
        BILLING_PERIOD=$(ls billing/output/*.sync.json 2>/dev/null | head -1 | grep -oE '[0-9]{4}-[0-9]{2}' | head -1 || echo "")
        if [ -z "$BILLING_PERIOD" ]; then
          echo "‚ùå Could not detect billing period"
          exit 1
        fi
        echo "üìÖ Auto-detected period: $BILLING_PERIOD"
      fi
      export BILLING_PERIOD
    - python billing/scripts/send_billing_email.py
