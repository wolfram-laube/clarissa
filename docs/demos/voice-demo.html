<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CLARISSA Voice Demo</title>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <style>
        :root {
            --bg-primary: #0f0f1a;
            --bg-secondary: #1a1a2e;
            --bg-tertiary: #252542;
            --accent: #e94560;
            --accent-hover: #ff6b8a;
            --success: #4ade80;
            --warning: #fbbf24;
            --text-primary: #f1f1f1;
            --text-secondary: #a0a0a0;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        header {
            background: var(--bg-secondary);
            padding: 1rem 2rem;
            border-bottom: 1px solid var(--bg-tertiary);
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        header h1 {
            font-size: 1.5rem;
            font-weight: 600;
        }
        
        header .badge {
            background: var(--accent);
            padding: 0.25rem 0.75rem;
            border-radius: 999px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        main {
            flex: 1;
            display: grid;
            grid-template-columns: 1fr 1.5fr;
            gap: 1rem;
            padding: 1rem;
            max-width: 1400px;
            margin: 0 auto;
            width: 100%;
        }
        
        @media (max-width: 900px) {
            main {
                grid-template-columns: 1fr;
            }
        }
        
        .panel {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        
        .panel-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        /* Voice Control Panel */
        .voice-control {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1.5rem;
            padding: 2rem 1rem;
        }
        
        #recordBtn {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            border: none;
            background: linear-gradient(135deg, var(--accent), #c73e54);
            color: white;
            font-size: 3rem;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 20px rgba(233, 69, 96, 0.4);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        #recordBtn:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 30px rgba(233, 69, 96, 0.5);
        }
        
        #recordBtn.recording {
            background: linear-gradient(135deg, #ff6b8a, var(--accent));
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(233, 69, 96, 0.7); }
            50% { box-shadow: 0 0 0 20px rgba(233, 69, 96, 0); }
        }
        
        #status {
            text-align: center;
            color: var(--text-secondary);
            min-height: 3rem;
        }
        
        #status.success { color: var(--success); }
        #status.error { color: var(--accent); }
        #status.recording { color: var(--warning); }
        
        /* Transcript */
        #transcript {
            background: var(--bg-tertiary);
            padding: 1rem;
            border-radius: 8px;
            min-height: 60px;
            font-family: 'SF Mono', Monaco, monospace;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }
        
        #transcript.has-text {
            color: var(--text-primary);
        }
        
        /* Intent Display */
        .intent-display {
            display: grid;
            grid-template-columns: auto 1fr;
            gap: 0.5rem 1rem;
            font-size: 0.9rem;
        }
        
        .intent-label {
            color: var(--text-secondary);
        }
        
        .intent-value {
            font-family: 'SF Mono', Monaco, monospace;
            color: var(--success);
        }
        
        .intent-value.unknown {
            color: var(--accent);
        }
        
        /* Command Examples */
        .examples {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .example {
            background: var(--bg-tertiary);
            padding: 0.75rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .example:hover {
            background: var(--bg-primary);
            transform: translateX(4px);
        }
        
        .example .icon {
            font-size: 1.2rem;
        }
        
        /* Visualization Panel */
        #vizContainer {
            flex: 1;
            min-height: 400px;
            background: var(--bg-tertiary);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
        }
        
        #vizContainer.has-viz {
            background: transparent;
        }
        
        /* Response Text */
        #responseText {
            background: var(--bg-tertiary);
            padding: 1rem;
            border-radius: 8px;
            font-size: 1rem;
            line-height: 1.5;
            min-height: 60px;
        }
        
        /* API Key Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .modal.show {
            display: flex;
        }
        
        .modal-content {
            background: var(--bg-secondary);
            padding: 2rem;
            border-radius: 12px;
            max-width: 450px;
            width: 90%;
        }
        
        .modal-content h2 {
            margin-bottom: 1rem;
        }
        
        .modal-content p {
            color: var(--text-secondary);
            margin-bottom: 1rem;
            font-size: 0.9rem;
        }
        
        .modal-content input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--bg-tertiary);
            border-radius: 8px;
            background: var(--bg-primary);
            color: var(--text-primary);
            font-family: 'SF Mono', Monaco, monospace;
            font-size: 0.85rem;
            margin-bottom: 1rem;
        }
        
        .modal-content button {
            width: 100%;
            padding: 0.75rem;
            border: none;
            border-radius: 8px;
            background: var(--accent);
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .modal-content button:hover {
            background: var(--accent-hover);
        }
        
        .modal-content .note {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-top: 1rem;
        }
        
        footer {
            background: var(--bg-secondary);
            padding: 1rem 2rem;
            text-align: center;
            color: var(--text-secondary);
            font-size: 0.85rem;
            border-top: 1px solid var(--bg-tertiary);
        }
        
        footer a {
            color: var(--accent);
            text-decoration: none;
        }
        
        footer a:hover {
            text-decoration: underline;
        }
        
        /* Demo mode indicator */
        .demo-mode {
            background: var(--warning);
            color: #000;
            padding: 0.5rem 1rem;
            text-align: center;
            font-size: 0.85rem;
        }
    </style>
</head>
<body>
    <div id="demoModeBar" class="demo-mode" style="display: none;">
        üé≠ Demo Mode - Using simulated responses. <a href="#" onclick="showApiModal(); return false;">Add API key</a> for real Whisper transcription.
    </div>
    
    <header>
        <h1>üé§ CLARISSA Voice Demo</h1>
        <span class="badge">PROTOTYPE</span>
    </header>
    
    <main>
        <div class="left-panels">
            <div class="panel">
                <div class="panel-title">üéôÔ∏è Voice Input</div>
                <div class="voice-control">
                    <button id="recordBtn" onclick="toggleRecording()">üé§</button>
                    <div id="status">Click to start recording</div>
                </div>
                
                <div class="panel-title">üìù Transcription</div>
                <div id="transcript">Your spoken command will appear here...</div>
                
                <div class="panel-title">üß† Parsed Intent</div>
                <div class="intent-display">
                    <span class="intent-label">Intent:</span>
                    <span id="intentType" class="intent-value">‚Äî</span>
                    <span class="intent-label">Confidence:</span>
                    <span id="intentConf" class="intent-value">‚Äî</span>
                    <span class="intent-label">Slots:</span>
                    <span id="intentSlots" class="intent-value">‚Äî</span>
                </div>
            </div>
            
            <div class="panel">
                <div class="panel-title">üí° Try These Commands</div>
                <div class="examples">
                    <div class="example" onclick="simulateCommand('show me the permeability')">
                        <span class="icon">üó∫Ô∏è</span>
                        <span>"Show me the permeability"</span>
                    </div>
                    <div class="example" onclick="simulateCommand('show water saturation at layer 3')">
                        <span class="icon">üíß</span>
                        <span>"Show water saturation at layer 3"</span>
                    </div>
                    <div class="example" onclick="simulateCommand('what is the oil rate')">
                        <span class="icon">üìä</span>
                        <span>"What is the oil rate?"</span>
                    </div>
                    <div class="example" onclick="simulateCommand('show porosity in 3D')">
                        <span class="icon">üßä</span>
                        <span>"Show porosity in 3D"</span>
                    </div>
                    <div class="example" onclick="simulateCommand('help')">
                        <span class="icon">‚ùì</span>
                        <span>"Help"</span>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="right-panels">
            <div class="panel" style="flex: 1;">
                <div class="panel-title">üìä Visualization</div>
                <div id="vizContainer">
                    <span>Visualization will appear here</span>
                </div>
            </div>
            
            <div class="panel">
                <div class="panel-title">üí¨ Response</div>
                <div id="responseText">CLARISSA's response will appear here...</div>
            </div>
        </div>
    </main>
    
    <footer>
        Part of <a href="https://gitlab.com/wolfram_laube/blauweiss_llc/clarissa" target="_blank">CLARISSA</a> - 
        Conversational Language Agent for Reservoir Simulation | 
        <a href="#" onclick="showApiModal(); return false;">‚öôÔ∏è Settings</a>
    </footer>
    
    <!-- API Key Modal -->
    <div id="apiModal" class="modal">
        <div class="modal-content">
            <h2>üîë OpenAI API Key</h2>
            <p>Enter your API key for real speech-to-text transcription with Whisper.</p>
            <input type="password" id="apiKeyInput" placeholder="sk-..." />
            <button onclick="saveApiKey()">Save & Enable</button>
            <p class="note">
                üîí Your key is stored locally in your browser only.<br>
                No key? The demo works with simulated responses too!
            </p>
            <button onclick="hideApiModal()" style="margin-top: 0.5rem; background: var(--bg-tertiary);">
                Use Demo Mode
            </button>
        </div>
    </div>

    <script>
        // ============================================
        // CLARISSA Voice Demo - Frontend Logic
        // ============================================
        
        let mediaRecorder;
        let audioChunks = [];
        let isRecording = false;
        let apiKey = localStorage.getItem('openai_api_key') || '';
        
        // Demo mode if no API key
        const isDemoMode = () => !apiKey;
        
        // Show demo mode bar if needed
        if (isDemoMode()) {
            document.getElementById('demoModeBar').style.display = 'block';
        }
        
        // ============================================
        // Recording Functions
        // ============================================
        
        async function toggleRecording() {
            const btn = document.getElementById('recordBtn');
            const status = document.getElementById('status');
            
            if (!isRecording) {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ 
                        audio: {
                            channelCount: 1,
                            sampleRate: 16000
                        } 
                    });
                    
                    mediaRecorder = new MediaRecorder(stream, {
                        mimeType: 'audio/webm;codecs=opus'
                    });
                    audioChunks = [];
                    
                    mediaRecorder.ondataavailable = (e) => {
                        if (e.data.size > 0) {
                            audioChunks.push(e.data);
                        }
                    };
                    
                    mediaRecorder.onstop = async () => {
                        stream.getTracks().forEach(track => track.stop());
                        const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                        await processAudio(audioBlob);
                    };
                    
                    mediaRecorder.start();
                    isRecording = true;
                    btn.classList.add('recording');
                    btn.textContent = '‚èπÔ∏è';
                    status.textContent = 'üî¥ Recording... click to stop';
                    status.className = 'recording';
                    
                } catch (err) {
                    console.error('Mic error:', err);
                    status.textContent = '‚ùå Microphone access denied. Check browser permissions.';
                    status.className = 'error';
                }
            } else {
                mediaRecorder.stop();
                isRecording = false;
                btn.classList.remove('recording');
                btn.textContent = 'üé§';
                status.textContent = '‚è≥ Processing...';
                status.className = '';
            }
        }
        
        // ============================================
        // Audio Processing
        // ============================================
        
        async function processAudio(audioBlob) {
            const status = document.getElementById('status');
            const transcript = document.getElementById('transcript');
            
            try {
                let text;
                
                if (isDemoMode()) {
                    // Demo mode: use simple speech recognition if available
                    text = await demoTranscribe();
                } else {
                    // Real mode: use Whisper API
                    text = await whisperTranscribe(audioBlob);
                }
                
                transcript.textContent = text;
                transcript.classList.add('has-text');
                
                // Parse and execute
                await processCommand(text);
                
                status.textContent = '‚úÖ Command processed';
                status.className = 'success';
                
            } catch (err) {
                console.error('Processing error:', err);
                status.textContent = '‚ùå ' + err.message;
                status.className = 'error';
            }
        }
        
        async function whisperTranscribe(audioBlob) {
            const formData = new FormData();
            formData.append('file', audioBlob, 'audio.webm');
            formData.append('model', 'whisper-1');
            formData.append('language', 'en');
            formData.append('prompt', 'Reservoir simulation: permeability, porosity, saturation, pressure, layer, 3D, waterflood');
            
            const response = await fetch('https://api.openai.com/v1/audio/transcriptions', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${apiKey}`
                },
                body: formData
            });
            
            if (!response.ok) {
                const err = await response.json();
                throw new Error(err.error?.message || 'Whisper API error');
            }
            
            const data = await response.json();
            return data.text;
        }
        
        async function demoTranscribe() {
            // In demo mode, prompt user for text input
            return new Promise((resolve) => {
                const text = prompt('üé≠ Demo Mode\n\nMicrophone recorded! Enter what you said:\n\n(Or try: "show me the permeability")');
                resolve(text || 'help');
            });
        }
        
        // ============================================
        // Command Processing (Client-side Intent Parsing)
        // ============================================
        
        async function processCommand(text) {
            const intent = parseIntent(text);
            displayIntent(intent);
            await executeIntent(intent);
        }
        
        function parseIntent(text) {
            const lower = text.toLowerCase().trim();
            
            // Quick pattern matching
            if (['stop', 'cancel', 'never mind', 'abort'].includes(lower)) {
                return { type: 'cancel', confidence: 1.0, slots: {}, raw: text };
            }
            
            if (['yes', 'yeah', 'confirm', 'ok', 'okay'].includes(lower)) {
                return { type: 'confirm', confidence: 1.0, slots: {}, raw: text };
            }
            
            if (lower === 'help' || lower.includes('what can')) {
                return { type: 'help', confidence: 1.0, slots: {}, raw: text };
            }
            
            // Visualization patterns
            if (lower.includes('show') || lower.includes('display') || lower.includes('visualize')) {
                const slots = {};
                
                // Property extraction
                if (lower.includes('permeability') || lower.includes('perm')) {
                    slots.property = 'permeability';
                } else if (lower.includes('porosity') || lower.includes('poro')) {
                    slots.property = 'porosity';
                } else if (lower.includes('saturation') || lower.includes(' sw')) {
                    slots.property = 'water_saturation';
                } else if (lower.includes('pressure')) {
                    slots.property = 'pressure';
                }
                
                // Layer extraction
                const layerMatch = lower.match(/layer\s*(\d+)/);
                if (layerMatch) {
                    slots.layer = parseInt(layerMatch[1]);
                }
                
                // Time extraction
                const dayMatch = lower.match(/day\s*(\d+)/);
                if (dayMatch) {
                    slots.time_days = parseInt(dayMatch[1]);
                }
                
                // View type
                if (lower.includes('3d')) {
                    slots.view_type = '3d';
                } else if (slots.layer) {
                    slots.view_type = 'cross_section';
                }
                
                return { 
                    type: 'visualize_property', 
                    confidence: slots.property ? 0.95 : 0.7,
                    slots,
                    raw: text 
                };
            }
            
            // Query patterns
            if (lower.includes('what') || lower.includes('how much')) {
                const slots = {};
                
                if (lower.includes('oil rate') || lower.includes('production rate')) {
                    slots.property = 'oil_rate';
                } else if (lower.includes('water cut')) {
                    slots.property = 'water_cut';
                } else if (lower.includes('pressure') || lower.includes('bhp')) {
                    slots.property = 'pressure';
                } else if (lower.includes('cumulative') || lower.includes('total')) {
                    slots.property = 'cumulative_oil';
                }
                
                return {
                    type: 'query_value',
                    confidence: slots.property ? 0.9 : 0.6,
                    slots,
                    raw: text
                };
            }
            
            return { type: 'unknown', confidence: 0.3, slots: {}, raw: text };
        }
        
        function displayIntent(intent) {
            document.getElementById('intentType').textContent = intent.type;
            document.getElementById('intentType').className = 
                'intent-value' + (intent.type === 'unknown' ? ' unknown' : '');
            document.getElementById('intentConf').textContent = 
                (intent.confidence * 100).toFixed(0) + '%';
            document.getElementById('intentSlots').textContent = 
                Object.keys(intent.slots).length > 0 
                    ? JSON.stringify(intent.slots) 
                    : '‚Äî';
        }
        
        // ============================================
        // Intent Execution & Visualization
        // ============================================
        
        async function executeIntent(intent) {
            const responseEl = document.getElementById('responseText');
            const vizContainer = document.getElementById('vizContainer');
            
            switch (intent.type) {
                case 'visualize_property':
                    const prop = intent.slots.property || 'permeability';
                    const layer = intent.slots.layer;
                    
                    if (layer) {
                        responseEl.textContent = `Showing ${prop.replace('_', ' ')} at layer ${layer}.`;
                        createCrossSection(prop, layer);
                    } else {
                        responseEl.textContent = `Showing ${prop.replace('_', ' ')} in 3D.`;
                        create3DVisualization(prop);
                    }
                    break;
                    
                case 'query_value':
                    const values = {
                        'oil_rate': ['1,250', 'bbl/day'],
                        'water_cut': ['26', '%'],
                        'pressure': ['3,450', 'psi'],
                        'cumulative_oil': ['2.3', 'MMSTB']
                    };
                    const qprop = intent.slots.property || 'oil_rate';
                    const [val, unit] = values[qprop] || ['N/A', ''];
                    responseEl.textContent = `The ${qprop.replace('_', ' ')} is ${val} ${unit}.`;
                    break;
                    
                case 'help':
                    responseEl.innerHTML = `<strong>Available commands:</strong><br>
                        ‚Ä¢ "Show me the permeability/porosity/saturation"<br>
                        ‚Ä¢ "Show layer 3" - cross-section view<br>
                        ‚Ä¢ "What is the oil rate/water cut?"<br>
                        ‚Ä¢ "Help" - show this message`;
                    break;
                    
                case 'cancel':
                    responseEl.textContent = 'Cancelled.';
                    break;
                    
                case 'confirm':
                    responseEl.textContent = 'Confirmed.';
                    break;
                    
                default:
                    responseEl.textContent = "I didn't understand that. Try saying 'help' for available commands.";
            }
        }
        
        // ============================================
        // Plotly Visualizations
        // ============================================
        
        const NX = 10, NY = 10, NZ = 5;
        
        // Generate synthetic data
        function generateData(property) {
            const data = [];
            for (let i = 0; i < NX; i++) {
                data[i] = [];
                for (let j = 0; j < NY; j++) {
                    data[i][j] = [];
                    for (let k = 0; k < NZ; k++) {
                        let val;
                        if (property === 'permeability') {
                            val = Math.exp(4.5 + Math.random() * 0.5);
                            if (i >= 3 && i <= 6) val *= 3; // Channel
                        } else if (property === 'porosity') {
                            val = 0.15 + Math.random() * 0.1;
                        } else if (property === 'water_saturation') {
                            const dist = Math.sqrt(Math.pow(i - NX/2, 2) + Math.pow(j - NY/2, 2));
                            val = 0.2 + 0.5 * Math.max(0, 1 - dist / (NX * 0.5));
                        } else {
                            val = 3000 + Math.random() * 500;
                        }
                        data[i][j][k] = val;
                    }
                }
            }
            return data;
        }
        
        function create3DVisualization(property) {
            const data = generateData(property);
            const x = [], y = [], z = [], values = [];
            
            for (let i = 0; i < NX; i++) {
                for (let j = 0; j < NY; j++) {
                    for (let k = 0; k < NZ; k++) {
                        x.push(i);
                        y.push(j);
                        z.push(k);
                        values.push(data[i][j][k]);
                    }
                }
            }
            
            const trace = {
                x, y, z,
                mode: 'markers',
                type: 'scatter3d',
                marker: {
                    size: 8,
                    color: values,
                    colorscale: 'Viridis',
                    colorbar: { title: property.replace('_', ' ') },
                    opacity: 0.8
                }
            };
            
            const layout = {
                title: `3D ${property.replace('_', ' ')}`,
                paper_bgcolor: 'rgba(0,0,0,0)',
                plot_bgcolor: 'rgba(0,0,0,0)',
                font: { color: '#f1f1f1' },
                scene: {
                    xaxis: { title: 'X', gridcolor: '#333' },
                    yaxis: { title: 'Y', gridcolor: '#333' },
                    zaxis: { title: 'Layer', gridcolor: '#333' },
                    bgcolor: 'rgba(0,0,0,0)'
                },
                margin: { l: 0, r: 0, t: 40, b: 0 }
            };
            
            const container = document.getElementById('vizContainer');
            container.innerHTML = '';
            container.classList.add('has-viz');
            Plotly.newPlot(container, [trace], layout, { responsive: true });
        }
        
        function createCrossSection(property, layer) {
            const data = generateData(property);
            const layerIdx = Math.min(Math.max(layer - 1, 0), NZ - 1);
            
            const zData = [];
            for (let j = 0; j < NY; j++) {
                const row = [];
                for (let i = 0; i < NX; i++) {
                    row.push(data[i][j][layerIdx]);
                }
                zData.push(row);
            }
            
            const heatmap = {
                z: zData,
                type: 'heatmap',
                colorscale: 'Viridis',
                colorbar: { title: property.replace('_', ' ') }
            };
            
            // Well markers
            const producer = {
                x: [NX/2],
                y: [NY/2],
                mode: 'markers+text',
                type: 'scatter',
                marker: { size: 15, color: '#3b82f6', symbol: 'circle' },
                text: ['PROD1'],
                textposition: 'top center',
                textfont: { color: '#fff' },
                name: 'Producer'
            };
            
            const injectors = {
                x: [1, 1, NX-2, NX-2],
                y: [1, NY-2, 1, NY-2],
                mode: 'markers+text',
                type: 'scatter',
                marker: { size: 12, color: '#ef4444', symbol: 'triangle-up' },
                text: ['INJ1', 'INJ2', 'INJ3', 'INJ4'],
                textposition: 'top center',
                textfont: { color: '#fff' },
                name: 'Injectors'
            };
            
            const layout = {
                title: `${property.replace('_', ' ')} - Layer ${layer}`,
                paper_bgcolor: 'rgba(0,0,0,0)',
                plot_bgcolor: 'rgba(0,0,0,0)',
                font: { color: '#f1f1f1' },
                xaxis: { title: 'X', gridcolor: '#333' },
                yaxis: { title: 'Y', gridcolor: '#333' },
                margin: { l: 50, r: 50, t: 40, b: 50 }
            };
            
            const container = document.getElementById('vizContainer');
            container.innerHTML = '';
            container.classList.add('has-viz');
            Plotly.newPlot(container, [heatmap, producer, injectors], layout, { responsive: true });
        }
        
        // ============================================
        // Utility Functions
        // ============================================
        
        function simulateCommand(text) {
            document.getElementById('transcript').textContent = text;
            document.getElementById('transcript').classList.add('has-text');
            document.getElementById('status').textContent = '‚úÖ Command processed';
            document.getElementById('status').className = 'success';
            processCommand(text);
        }
        
        function showApiModal() {
            document.getElementById('apiModal').classList.add('show');
            document.getElementById('apiKeyInput').value = apiKey;
        }
        
        function hideApiModal() {
            document.getElementById('apiModal').classList.remove('show');
        }
        
        function saveApiKey() {
            const key = document.getElementById('apiKeyInput').value.trim();
            if (key && key.startsWith('sk-')) {
                apiKey = key;
                localStorage.setItem('openai_api_key', key);
                document.getElementById('demoModeBar').style.display = 'none';
                hideApiModal();
                alert('‚úÖ API key saved! Whisper transcription enabled.');
            } else {
                alert('Please enter a valid OpenAI API key (starts with sk-)');
            }
        }
        
        // Close modal on outside click
        document.getElementById('apiModal').addEventListener('click', (e) => {
            if (e.target.id === 'apiModal') hideApiModal();
        });
    </script>
</body>
</html>
