# =============================================================================
# SPE Europe 2026 Document Pipeline
# =============================================================================
# Trigger logic:
#   sources/** changed     â†’ llm_merge (collaborative authoring)
#   canonical/** changed   â†’ build_canonical_html â†’ build_canonical_pdf â†’ deploy
#   diagrams/*.mmd changed â†’ render_diagrams â†’ build_canonical_html â†’ build_canonical_pdf â†’ deploy
# =============================================================================

# -----------------------------------------------------------------------------
# PHASE 1: Collaborative Authoring (LLM-assisted merge)
# -----------------------------------------------------------------------------
llm_merge:
  stage: build
  tags:
    - docker
  image: python:3.11-slim
  rules:
    - if: $CI_PIPELINE_SOURCE == "push"
      changes:
        - "conference/spe-europe-2026/sources/**/*"
    - if: $CI_PIPELINE_SOURCE == "web"
      when: manual
      allow_failure: true
  variables:
    ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY}
    OPENAI_API_KEY: ${OPENAI_API_KEY}
  script:
    - pip install anthropic openai python-docx --quiet
    - python3 conference/spe-europe-2026/scripts/llm_merge.py
    - echo "ðŸ“ LLM merge complete. Review merged/abstract-merged.md and copy to canonical/ if approved."
  artifacts:
    paths:
      - conference/spe-europe-2026/merged/abstract-merged.md
    expire_in: 1 week

# -----------------------------------------------------------------------------
# PHASE 2: Diagram Rendering
# -----------------------------------------------------------------------------
render_diagrams:
  stage: build
  tags:
    - docker
  image: node:20-alpine
  rules:
    - if: $CI_PIPELINE_SOURCE == "push"
      changes:
        - "conference/spe-europe-2026/diagrams/*.mmd"
        - "conference/spe-europe-2026/canonical/**/*"
    - if: $CI_PIPELINE_SOURCE == "web"
      when: manual
      allow_failure: true
  before_script:
    - apk add --no-cache chromium python3
    - npm install -g @mermaid-js/mermaid-cli
    - export PUPPETEER_EXECUTABLE_PATH=/usr/bin/chromium-browser
    - export PUPPETEER_SKIP_CHROMIUM_DOWNLOAD=1
  script:
    - python3 conference/spe-europe-2026/scripts/render_diagrams.py
  artifacts:
    paths:
      - conference/spe-europe-2026/diagrams/*.svg
      - conference/spe-europe-2026/diagrams/*.png
    expire_in: 4 weeks

# -----------------------------------------------------------------------------
# PHASE 3: Build HTML from canonical sources
# -----------------------------------------------------------------------------
build_canonical_html:
  stage: test
  tags:
    - docker
  image: python:3.11-slim
  needs:
    - job: render_diagrams
      optional: true
      artifacts: true
  rules:
    - if: $CI_PIPELINE_SOURCE == "push"
      changes:
        - "conference/spe-europe-2026/canonical/**/*"
        - "conference/spe-europe-2026/diagrams/*.mmd"
    - if: $CI_PIPELINE_SOURCE == "web"
      when: manual
      allow_failure: true
  script:
    - python3 conference/spe-europe-2026/scripts/build_canonical.py
    - ls -la conference/spe-europe-2026/outputs/
  artifacts:
    paths:
      - conference/spe-europe-2026/outputs/*.html
    expire_in: 4 weeks

# -----------------------------------------------------------------------------
# PHASE 4: Generate PDFs via Puppeteer/Chromium
# -----------------------------------------------------------------------------
build_canonical_pdf:
  stage: deploy
  tags:
    - docker
  image: node:20-alpine
  needs:
    - job: build_canonical_html
      artifacts: true
  rules:
    - if: $CI_PIPELINE_SOURCE == "push"
      changes:
        - "conference/spe-europe-2026/canonical/**/*"
        - "conference/spe-europe-2026/diagrams/*.mmd"
    - if: $CI_PIPELINE_SOURCE == "web"
      when: manual
      allow_failure: true
  before_script:
    - apk add --no-cache chromium
    - npm install puppeteer
    - export PUPPETEER_EXECUTABLE_PATH=/usr/bin/chromium-browser
    - export PUPPETEER_SKIP_CHROMIUM_DOWNLOAD=1
  script:
    - |
      cat > generate-pdfs.js << 'JSEOF'
      const puppeteer = require('puppeteer');
      const fs = require('fs');
      const path = require('path');
      
      (async () => {
        const browser = await puppeteer.launch({
          headless: 'new',
          executablePath: process.env.PUPPETEER_EXECUTABLE_PATH,
          args: ['--no-sandbox', '--disable-setuid-sandbox', '--disable-dev-shm-usage']
        });
        
        const outputDir = 'conference/spe-europe-2026/outputs';
        const htmlFiles = fs.readdirSync(outputDir).filter(f => f.endsWith('.html'));
        
        for (const htmlFile of htmlFiles) {
          const htmlPath = path.join(outputDir, htmlFile);
          const pdfPath = htmlPath.replace('.html', '.pdf');
          
          console.log(`ðŸ“„ Converting ${htmlFile} â†’ ${path.basename(pdfPath)}`);
          
          const page = await browser.newPage();
          const html = fs.readFileSync(htmlPath, 'utf8');
          await page.setContent(html, { waitUntil: 'networkidle0' });
          
          // Wait for Mermaid diagrams to render
          await new Promise(r => setTimeout(r, 3000));
          
          await page.pdf({
            path: pdfPath,
            format: 'A4',
            margin: { top: '2cm', right: '2cm', bottom: '2cm', left: '2cm' },
            printBackground: true
          });
          
          console.log(`   âœ… ${path.basename(pdfPath)}`);
        }
        
        await browser.close();
        console.log('ðŸŽ‰ All PDFs generated!');
      })();
      JSEOF
    - node generate-pdfs.js
    - ls -la conference/spe-europe-2026/outputs/
  artifacts:
    paths:
      - conference/spe-europe-2026/outputs/
    expire_in: 4 weeks
    name: "spe-canonical-${CI_COMMIT_SHORT_SHA}"
