# document-merge.gitlab-ci.yml - SPE Europe 2026 Document Pipeline
# 
# WORKFLOW:
# =========
# 1. Collaborative Mode: sources/** â†’ llm_merge â†’ merged/ (needs review)
# 2. Canonical Mode:     canonical/** or diagrams/** â†’ render â†’ html/pdf â†’ pages
#
# Trigger Matrix:
# ---------------
# | Change in...        | Jobs triggered                              |
# |---------------------|---------------------------------------------|
# | sources/**          | llm_merge only (review before canonical)    |
# | canonical/**        | render_diagrams â†’ build_canonical â†’ deploy  |
# | diagrams/*.mmd      | render_diagrams â†’ build_canonical â†’ deploy  |

# ============================================================
# STAGE 1: LLM Merge (Collaborative Authoring)
# ============================================================
llm_merge:
  stage: build
  tags:
    - docker
  image: python:3.11-slim
  rules:
    - if: $CI_PIPELINE_SOURCE == "push"
      changes:
        - "conference/spe-europe-2026/sources/**/*"
    - if: $CI_PIPELINE_SOURCE == "web"
      when: manual
      allow_failure: true
  variables:
    ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY}
    OPENAI_API_KEY: ${OPENAI_API_KEY}
  script:
    - pip install anthropic openai python-docx --quiet
    - python3 conference/spe-europe-2026/scripts/llm_merge.py
    - echo "âœ… LLM merge complete - review merged/abstract-merged.md"
    - head -50 conference/spe-europe-2026/merged/abstract-merged.md
  artifacts:
    paths:
      - conference/spe-europe-2026/merged/abstract-merged.md
    expire_in: 1 week

# ============================================================
# STAGE 2: Render Diagrams (Mermaid â†’ SVG/PNG)
# ============================================================
render_diagrams:
  stage: build
  tags:
    - docker
  image: node:20-alpine
  rules:
    - if: $CI_PIPELINE_SOURCE == "push"
      changes:
        - "conference/spe-europe-2026/diagrams/*.mmd"
        - "conference/spe-europe-2026/canonical/**/*"
    - if: $CI_PIPELINE_SOURCE == "web"
      when: manual
      allow_failure: true
  before_script:
    - apk add --no-cache chromium
    - npm install -g @mermaid-js/mermaid-cli
    - export PUPPETEER_EXECUTABLE_PATH=/usr/bin/chromium-browser
  script:
    - |
      echo "ðŸŽ¨ Rendering Mermaid diagrams..."
      cd conference/spe-europe-2026/diagrams
      echo '{"args":["--no-sandbox","--disable-setuid-sandbox"]}' > puppeteer-config.json
      for mmd in *.mmd; do
        name="${mmd%.mmd}"
        echo "  â†’ $name"
        mmdc -i "$mmd" -o "${name}.svg" -p puppeteer-config.json -b transparent || true
        mmdc -i "$mmd" -o "${name}.png" -p puppeteer-config.json -b white -s 2 || true
      done
      echo "ðŸ“ Generated:"
      ls -la *.svg *.png 2>/dev/null || echo "No files"
  artifacts:
    paths:
      - conference/spe-europe-2026/diagrams/*.svg
      - conference/spe-europe-2026/diagrams/*.png
    expire_in: 1 week

# ============================================================
# STAGE 3a: Build Canonical HTML
# ============================================================
build_canonical_html:
  stage: test
  tags:
    - docker
  image: python:3.11-slim
  needs:
    - job: render_diagrams
      optional: true
      artifacts: true
  rules:
    - if: $CI_PIPELINE_SOURCE == "push"
      changes:
        - "conference/spe-europe-2026/canonical/**/*"
        - "conference/spe-europe-2026/diagrams/*.mmd"
    - if: $CI_PIPELINE_SOURCE == "web"
      when: manual
      allow_failure: true
  script:
    - mkdir -p doc-outputs/spe-submission
    - python3 conference/spe-europe-2026/scripts/build_canonical_html.py
    - ls -la doc-outputs/spe-submission/
  artifacts:
    paths:
      - doc-outputs/spe-submission/
    expire_in: 1 week

# ============================================================
# STAGE 3b: Build Canonical PDF
# ============================================================
build_canonical_pdf:
  stage: test
  tags:
    - docker
  image: node:20-alpine
  needs:
    - job: build_canonical_html
      artifacts: true
  rules:
    - if: $CI_PIPELINE_SOURCE == "push"
      changes:
        - "conference/spe-europe-2026/canonical/**/*"
        - "conference/spe-europe-2026/diagrams/*.mmd"
    - if: $CI_PIPELINE_SOURCE == "web"
      when: manual
      allow_failure: true
  before_script:
    - apk add --no-cache chromium
    - npm install puppeteer
    - export PUPPETEER_EXECUTABLE_PATH=/usr/bin/chromium-browser
  script:
    - |
      cat > generate-pdf.js << 'JSEOF'
      const puppeteer = require('puppeteer');
      const fs = require('fs');
      const path = require('path');
      (async () => {
        const browser = await puppeteer.launch({
          headless: 'new',
          executablePath: process.env.PUPPETEER_EXECUTABLE_PATH,
          args: ['--no-sandbox', '--disable-setuid-sandbox', '--disable-dev-shm-usage']
        });
        const dir = 'doc-outputs/spe-submission';
        const files = fs.readdirSync(dir).filter(f => f.endsWith('.html'));
        for (const file of files) {
          const page = await browser.newPage();
          const html = fs.readFileSync(path.join(dir, file), 'utf8');
          await page.setContent(html, { waitUntil: 'networkidle0' });
          await new Promise(r => setTimeout(r, 2000));
          await page.pdf({
            path: path.join(dir, file.replace('.html', '.pdf')),
            format: 'A4',
            margin: { top: '2cm', right: '2cm', bottom: '2cm', left: '2cm' },
            printBackground: true
          });
          console.log('Generated:', file.replace('.html', '.pdf'));
        }
        await browser.close();
      })();
      JSEOF
    - node generate-pdf.js
    - ls -la doc-outputs/spe-submission/
  artifacts:
    paths:
      - doc-outputs/spe-submission/
    expire_in: 1 month
    name: "spe-canonical-${CI_COMMIT_SHORT_SHA}"

# ============================================================
# LEGACY: Build merged/ HTML
# ============================================================
build_merged_html:
  stage: test
  tags:
    - docker
  image: python:3.11-slim
  needs:
    - job: llm_merge
      optional: true
      artifacts: true
  rules:
    - if: $CI_PIPELINE_SOURCE == "push"
      changes:
        - "conference/spe-europe-2026/sources/**/*"
        - "conference/spe-europe-2026/merged/**/*"
    - if: $CI_PIPELINE_SOURCE == "web"
      when: manual
      allow_failure: true
  script:
    - python3 conference/spe-europe-2026/scripts/md_to_html.py
    - ls -la doc-outputs/
  artifacts:
    paths:
      - doc-outputs/
    expire_in: 1 week

# ============================================================
# LEGACY: Generate merged/ PDF
# ============================================================
generate_merged_pdf:
  stage: deploy
  tags:
    - docker
  image: node:20-alpine
  needs:
    - job: build_merged_html
      artifacts: true
  rules:
    - if: $CI_PIPELINE_SOURCE == "push"
      changes:
        - "conference/spe-europe-2026/sources/**/*"
        - "conference/spe-europe-2026/merged/**/*"
    - if: $CI_PIPELINE_SOURCE == "web"
      when: manual
      allow_failure: true
  before_script:
    - apk add --no-cache chromium
    - npm install puppeteer
    - export PUPPETEER_EXECUTABLE_PATH=/usr/bin/chromium-browser
  script:
    - ls -la doc-outputs/
    - |
      cat > generate-pdf.js << 'JSEOF'
      const puppeteer = require('puppeteer');
      const fs = require('fs');
      (async () => {
        const browser = await puppeteer.launch({
          headless: 'new',
          executablePath: process.env.PUPPETEER_EXECUTABLE_PATH,
          args: ['--no-sandbox', '--disable-setuid-sandbox', '--disable-dev-shm-usage']
        });
        const page = await browser.newPage();
        const html = fs.readFileSync('doc-outputs/abstract-merged.html', 'utf8');
        await page.setContent(html, { waitUntil: 'networkidle0' });
        await new Promise(r => setTimeout(r, 3000));
        await page.pdf({
          path: 'doc-outputs/abstract-merged.pdf',
          format: 'A4',
          margin: { top: '2cm', right: '2cm', bottom: '2cm', left: '2cm' },
          printBackground: true
        });
        await browser.close();
      })();
      JSEOF
    - node generate-pdf.js
    - ls -la doc-outputs/
  artifacts:
    paths:
      - doc-outputs/
    expire_in: 1 month
    name: "spe-merged-${CI_COMMIT_SHORT_SHA}"
