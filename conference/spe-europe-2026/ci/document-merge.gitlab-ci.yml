# document-merge.gitlab-ci.yml - Document generation for SPE abstract

# ============================================================
# Render Mermaid diagrams
# ============================================================
render_diagrams:
  stage: build
  tags:
    - docker
  image: node:20-alpine
  rules:
    - if: $CI_PIPELINE_SOURCE == "push"
      changes:
        - "conference/spe-europe-2026/**/*"
    - if: $CI_PIPELINE_SOURCE == "web"
      when: manual
      allow_failure: true
  before_script:
    - apk add --no-cache chromium
    - npm install -g @mermaid-js/mermaid-cli
    - export PUPPETEER_EXECUTABLE_PATH=/usr/bin/chromium-browser
  script:
    - mkdir -p rendered-diagrams
    - |
      echo '{"theme":"base","themeVariables":{"primaryColor":"#e8f0f8","primaryTextColor":"#003366","fontSize":"16px"}}' > mermaid-config.json
    - |
      for mmd in conference/spe-europe-2026/diagrams/*.mmd; do
        [ -f "$mmd" ] || continue
        name=$(basename "$mmd" .mmd)
        echo "Rendering: $name"
        mmdc -i "$mmd" -o "rendered-diagrams/${name}.svg" -c mermaid-config.json -w 1200 --scale 2 || true
      done
    - ls -la rendered-diagrams/
  artifacts:
    paths:
      - rendered-diagrams/
    expire_in: 1 week

# ============================================================
# Generate PDF via Chromium
# ============================================================
generate_spe_pdf:
  stage: deploy
  tags:
    - docker
  image: node:20-alpine
  needs:
    - job: render_diagrams
      optional: true
  rules:
    - if: $CI_PIPELINE_SOURCE == "push"
      changes:
        - "conference/spe-europe-2026/**/*"
    - if: $CI_PIPELINE_SOURCE == "web"
      when: manual
      allow_failure: true
  before_script:
    - apk add --no-cache chromium
    - npm install puppeteer
    - export PUPPETEER_EXECUTABLE_PATH=/usr/bin/chromium-browser
  script:
    - mkdir -p doc-outputs
    - |
      cat > generate-pdf.js << 'JSEOF'
      const puppeteer = require('puppeteer');
      const fs = require('fs');
      (async () => {
        const browser = await puppeteer.launch({
          headless: 'new',
          executablePath: process.env.PUPPETEER_EXECUTABLE_PATH,
          args: ['--no-sandbox', '--disable-setuid-sandbox', '--disable-dev-shm-usage']
        });
        const page = await browser.newPage();
        const html = fs.readFileSync('conference/spe-europe-2026/merged/abstract-merged.html', 'utf8');
        await page.setContent(html, { waitUntil: 'networkidle0' });
        await new Promise(r => setTimeout(r, 3000));
        await page.pdf({
          path: 'doc-outputs/abstract-merged.pdf',
          format: 'A4',
          margin: { top: '2cm', right: '2cm', bottom: '2cm', left: '2cm' },
          printBackground: true
        });
        console.log('PDF generated!');
        await browser.close();
      })();
      JSEOF
    - node generate-pdf.js
    - cp conference/spe-europe-2026/merged/abstract-merged.html doc-outputs/
    - ls -la doc-outputs/
  artifacts:
    paths:
      - doc-outputs/
    expire_in: 1 month
    name: "spe-abstract-${CI_COMMIT_SHORT_SHA}"
