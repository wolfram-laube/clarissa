# document-merge.gitlab-ci.yml - LLM-based document merge for SPE abstract

# ============================================================
# LLM Merge - Combine Doug + Wolfram contributions
# ============================================================
llm_merge:
  stage: build
  tags:
    - docker
  image: python:3.11-slim
  rules:
    - if: $CI_PIPELINE_SOURCE == "push"
      changes:
        - "conference/spe-europe-2026/sources/**/*"
    - if: $CI_PIPELINE_SOURCE == "web"
      when: manual
      allow_failure: true
  variables:
    ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY}
    OPENAI_API_KEY: ${OPENAI_API_KEY}
  script:
    - pip install anthropic openai python-docx --quiet
    - python3 conference/spe-europe-2026/scripts/llm_merge.py
    - echo "=== First 80 lines ==="
    - head -80 conference/spe-europe-2026/merged/abstract-merged.md
  artifacts:
    paths:
      - conference/spe-europe-2026/merged/abstract-merged.md
    expire_in: 1 week

# ============================================================
# Convert MD to HTML with Pandoc + Mermaid
# ============================================================
build_html:
  stage: test
  tags:
    - docker
  image: pandoc/latex:latest
  needs:
    - job: llm_merge
      optional: true
  rules:
    - if: $CI_PIPELINE_SOURCE == "push"
      changes:
        - "conference/spe-europe-2026/**/*"
    - if: $CI_PIPELINE_SOURCE == "web"
      when: manual
      allow_failure: true
  script:
    - mkdir -p doc-outputs
    - |
      # Convert MD to HTML with pandoc
      pandoc conference/spe-europe-2026/merged/abstract-merged.md \
        -f markdown \
        -t html5 \
        --standalone \
        --metadata title="CLARISSA - SPE Europe 2026" \
        -o doc-outputs/temp.html
    - |
      # Inject Mermaid JS and custom CSS
      cat > doc-outputs/header.html << 'HEADER'
      <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
      <style>
        body { 
          font-family: 'Segoe UI', Tahoma, sans-serif; 
          max-width: 850px; 
          margin: 0 auto; 
          padding: 2rem; 
          line-height: 1.6;
          font-size: 11pt;
          color: #333;
        }
        h1 { color: #003366; border-bottom: 3px solid #003366; padding-bottom: 0.5rem; }
        h2 { color: #003366; margin-top: 2rem; border-bottom: 1px solid #ccc; padding-bottom: 0.3rem; }
        h3 { color: #0066cc; }
        p { margin: 0.8em 0; text-align: justify; }
        pre { background: #f5f5f5; padding: 1rem; overflow-x: auto; border-radius: 4px; }
        code { font-family: Consolas, Monaco, monospace; font-size: 0.9em; }
        table { border-collapse: collapse; width: 100%; margin: 1.5rem 0; }
        th, td { border: 1px solid #ddd; padding: 0.6rem; text-align: left; }
        th { background: #003366; color: white; }
        tr:nth-child(even) { background: #f9f9f9; }
        .mermaid, pre code.language-mermaid { 
          background: #f8f9fa; 
          padding: 1rem; 
          margin: 1.5rem 0; 
          border-radius: 8px;
          display: block;
        }
        hr { border: none; border-top: 2px solid #003366; margin: 2rem 0; }
        strong { color: #003366; }
      </style>
      <script>
        document.addEventListener('DOMContentLoaded', function() {
          // Convert code blocks with mermaid class to mermaid divs
          document.querySelectorAll('pre code.language-mermaid, pre.mermaid').forEach(function(el) {
            var div = document.createElement('div');
            div.className = 'mermaid';
            div.textContent = el.textContent;
            el.parentNode.replaceWith(div);
          });
          mermaid.initialize({
            startOnLoad: true, 
            theme: 'base',
            themeVariables: { primaryColor: '#e8f0f8', primaryTextColor: '#003366', fontSize: '14px' }
          });
        });
      </script>
      HEADER
    - |
      # Inject header into HTML
      sed -i 's|</head>|'"$(cat doc-outputs/header.html | tr '\n' ' ')"'</head>|' doc-outputs/temp.html
      mv doc-outputs/temp.html doc-outputs/abstract-merged.html
    - ls -la doc-outputs/
    - head -50 doc-outputs/abstract-merged.html
  artifacts:
    paths:
      - doc-outputs/
    expire_in: 1 week

# ============================================================
# Generate PDF via Chromium
# ============================================================
generate_pdf:
  stage: deploy
  tags:
    - docker
  image: node:20-alpine
  needs:
    - job: build_html
  rules:
    - if: $CI_PIPELINE_SOURCE == "push"
      changes:
        - "conference/spe-europe-2026/**/*"
    - if: $CI_PIPELINE_SOURCE == "web"
      when: manual
      allow_failure: true
  before_script:
    - apk add --no-cache chromium
    - npm install puppeteer
    - export PUPPETEER_EXECUTABLE_PATH=/usr/bin/chromium-browser
    - export PUPPETEER_SKIP_CHROMIUM_DOWNLOAD=1
  script:
    - |
      cat > generate-pdf.js << 'JSEOF'
      const puppeteer = require('puppeteer');
      const fs = require('fs');
      (async () => {
        const browser = await puppeteer.launch({
          headless: 'new',
          executablePath: process.env.PUPPETEER_EXECUTABLE_PATH,
          args: ['--no-sandbox', '--disable-setuid-sandbox', '--disable-dev-shm-usage']
        });
        const page = await browser.newPage();
        const html = fs.readFileSync('doc-outputs/abstract-merged.html', 'utf8');
        await page.setContent(html, { waitUntil: 'networkidle0' });
        // Wait for Mermaid to render
        await new Promise(r => setTimeout(r, 4000));
        await page.pdf({
          path: 'doc-outputs/abstract-merged.pdf',
          format: 'A4',
          margin: { top: '2cm', right: '2cm', bottom: '2cm', left: '2cm' },
          printBackground: true
        });
        console.log('PDF generated!');
        await browser.close();
      })();
      JSEOF
    - node generate-pdf.js
    - ls -la doc-outputs/
  artifacts:
    paths:
      - doc-outputs/
    expire_in: 1 month
    name: "spe-abstract-${CI_COMMIT_SHORT_SHA}"
