# document-merge.gitlab-ci.yml - Fixed Document Pipeline
# Uses Chromium headless for PDF generation (renders Mermaid correctly)

variables:
  DOC_BASE_PATH: "conference/spe-europe-2026"

stages:
  - render_diagrams
  - generate

# ============================================================
# Pre-render Mermaid diagrams to SVG with larger fonts
# ============================================================
render_diagrams:
  stage: render_diagrams
  image: minlag/mermaid-cli:latest
  rules:
    - if: $CI_PIPELINE_SOURCE == "push"
      changes:
        - "conference/spe-europe-2026/**/*"
    - if: $CI_PIPELINE_SOURCE == "web"
      when: manual
      allow_failure: true
  script:
    - mkdir -p rendered-diagrams
    - |
      echo '{"theme":"base","themeVariables":{"primaryColor":"#e8f0f8","primaryTextColor":"#003366","fontSize":"16px"}}' > mermaid-config.json
    - |
      for mmd in ${DOC_BASE_PATH}/diagrams/*.mmd; do
        [ -f "$mmd" ] || continue
        name=$(basename "$mmd" .mmd)
        echo "Rendering: $name"
        mmdc -i "$mmd" -o "rendered-diagrams/${name}.svg" -c mermaid-config.json -w 1200 --scale 2 || true
        mmdc -i "$mmd" -o "rendered-diagrams/${name}.png" -c mermaid-config.json -w 1200 --scale 2 || true
      done
    - ls -la rendered-diagrams/
  artifacts:
    paths:
      - rendered-diagrams/
    expire_in: 1 week

# ============================================================
# Generate PDF from HTML via Chromium (renders Mermaid!)
# ============================================================
generate_outputs:
  stage: generate
  image: zenika/alpine-chrome:with-puppeteer
  needs:
    - job: render_diagrams
      optional: true
  rules:
    - if: $CI_PIPELINE_SOURCE == "push"
      changes:
        - "conference/spe-europe-2026/**/*"
    - if: $CI_PIPELINE_SOURCE == "web"
      when: manual
      allow_failure: true
  script:
    - mkdir -p doc-outputs
    - apk add --no-cache nodejs npm
    - npm install puppeteer
    - |
      cat > generate-pdf.js << 'JSEOF'
      const puppeteer = require('puppeteer');
      const fs = require('fs');
      (async () => {
        const browser = await puppeteer.launch({
          headless: 'new',
          args: ['--no-sandbox', '--disable-setuid-sandbox']
        });
        const page = await browser.newPage();
        const html = fs.readFileSync('conference/spe-europe-2026/merged/abstract-merged.html', 'utf8');
        await page.setContent(html, { waitUntil: 'networkidle0' });
        await new Promise(r => setTimeout(r, 3000));
        await page.pdf({
          path: 'doc-outputs/abstract-merged.pdf',
          format: 'A4',
          margin: { top: '2cm', right: '2cm', bottom: '2cm', left: '2cm' },
          printBackground: true
        });
        console.log('PDF generated!');
        await browser.close();
      })();
      JSEOF
    - node generate-pdf.js
    - cp ${DOC_BASE_PATH}/merged/abstract-merged.html doc-outputs/
    - ls -la doc-outputs/
  artifacts:
    paths:
      - doc-outputs/
    expire_in: 1 month
    name: "spe-abstract-${CI_COMMIT_SHORT_SHA}"
